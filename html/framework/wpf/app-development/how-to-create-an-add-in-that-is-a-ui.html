<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>&#1055;&#1088;&#1072;&#1082;&#1090;&#1080;&#1095;&#1077;&#1089;&#1082;&#1086;&#1077; &#1088;&#1091;&#1082;&#1086;&#1074;&#1086;&#1076;&#1089;&#1090;&#1074;&#1086;. &#1057;&#1086;&#1079;&#1076;&#1072;&#1085;&#1080;&#1077; &#1085;&#1072;&#1076;&#1089;&#1090;&#1088;&#1086;&#1081;&#1082;&#1080;, &#1103;&#1074;&#1083;&#1103;&#1102;&#1097;&#1077;&#1081;&#1089;&#1103; &#1087;&#1086;&#1083;&#1100;&#1079;&#1086;&#1074;&#1072;&#1090;&#1077;&#1083;&#1100;&#1089;&#1082;&#1080;&#1084; &#1080;&#1085;&#1090;&#1077;&#1088;&#1092;&#1077;&#1081;&#1089;&#1086;&#1084; | &#1053;&#1077;&#1086;&#1092;&#1080;&#1094;&#1080;&#1072;&#1083;&#1100;&#1085;&#1072;&#1103; &#1076;&#1086;&#1082;&#1091;&#1084;&#1077;&#1085;&#1090;&#1072;&#1094;&#1080;&#1103; .NET </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="&#1055;&#1088;&#1072;&#1082;&#1090;&#1080;&#1095;&#1077;&#1089;&#1082;&#1086;&#1077; &#1088;&#1091;&#1082;&#1086;&#1074;&#1086;&#1076;&#1089;&#1090;&#1074;&#1086;. &#1057;&#1086;&#1079;&#1076;&#1072;&#1085;&#1080;&#1077; &#1085;&#1072;&#1076;&#1089;&#1090;&#1088;&#1086;&#1081;&#1082;&#1080;, &#1103;&#1074;&#1083;&#1103;&#1102;&#1097;&#1077;&#1081;&#1089;&#1103; &#1087;&#1086;&#1083;&#1100;&#1079;&#1086;&#1074;&#1072;&#1090;&#1077;&#1083;&#1100;&#1089;&#1082;&#1080;&#1084; &#1080;&#1085;&#1090;&#1077;&#1088;&#1092;&#1077;&#1081;&#1089;&#1086;&#1084; | &#1053;&#1077;&#1086;&#1092;&#1080;&#1094;&#1080;&#1072;&#1083;&#1100;&#1085;&#1072;&#1103; &#1076;&#1086;&#1082;&#1091;&#1084;&#1077;&#1085;&#1090;&#1072;&#1094;&#1080;&#1103; .NET ">
    <meta name="generator" content="docfx 2.40.12.0">
    
    <link rel="shortcut icon" href="../../../favicon.ico">
    <link rel="stylesheet" href="../../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../../styles/docfx.css">
    <link rel="stylesheet" href="../../../styles/main.css">
    <meta property="docfx:navrel" content="../../../toc.html">
    <meta property="docfx:tocrel" content="toc.html">
    
    
    
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../../index.html">
                <img id="logo" class="svg" src="../../../logo.svg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h1 id="how-to-create-an-add-in-that-is-a-ui">Практическое руководство. Создание надстройки, являющейся пользовательским интерфейсом</h1>

<p>В этом примере показано, как создать надстройку, Windows Presentation Foundation (WPF), размещаемый в автономное приложение WPF.</p>
<p>Надстройка — это пользовательский Интерфейс, который является пользовательский элемент управления WPF. Содержимое пользовательского элемента управления составляет одна кнопка, при нажатии которой отображается окно сообщения. Автономное приложение WPF размещает пользовательского интерфейса надстройки как содержимое главного окна приложения.</p>
<p><strong>Предварительные требования</strong></p>
<p>В этом примере представлены расширения WPF модель надстроек платформы .NET Framework, реализовать этот сценарий и предполагается следующее:</p>
<ul>
<li><p>Знание модели надстроек платформы .NET Framework, включая конвейер, надстройка и разработку основного приложения. Если вы не знакомы с этими понятиями, см. в разделе <a href="/previous-versions/dotnet/netframework-4.0/bb384200(v%3dvs.100)">надстройки и расширения</a>. Учебник, в котором демонстрируется реализация конвейера, надстройки и ведущего приложения, см. в разделе <a href="/previous-versions/dotnet/netframework-4.0/bb788290(v%3dvs.100)">Пошаговое руководство: Создание расширяемого приложения</a>.</p>
</li>
<li><p>Знание расширений WPF в .NET Framework модель. См. в разделе <a href="wpf-add-ins-overview.html">Общие сведения о надстройках WPF</a>.</p>
</li>
</ul>
<h2 id="example">Пример</h2>
<p>Создание надстройки, являющейся пользовательским Интерфейсом WPF требуется специальный код для каждого сегмента конвейера, надстройки и ведущего приложения.</p>
<p><a name="Contract"></a></p>
<h2 id="implementing-the-contract-pipeline-segment">Реализация сегмента конвейера контракта</h2>
<p>Если надстройка является пользовательским Интерфейсом, контракт для надстройки должен реализовывать <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.addin.contract.inativehandlecontract">INativeHandleContract</a>. В примере <code>IWPFAddInContract</code> реализует <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.addin.contract.inativehandlecontract">INativeHandleContract</a>, как показано в следующем коде.</p>
<pre><code class="lang-csharp" name="SimpleAddInIsAUISample#ContractCode">using System.AddIn.Contract;
using System.AddIn.Pipeline;

namespace Contracts
{
    /// &lt;summary&gt;
    /// Defines the services that an add-in will provide to a host application.
    /// In this case, the add-in is a UI.
    /// &lt;/summary&gt;
    [AddInContract]
    public interface IWPFAddInContract : INativeHandleContract {}
}
</code></pre>
<p><a name="AddInViewPipeline"></a></p>
<h2 id="implementing-the-add-in-view-pipeline-segment">Реализация сегмента конвейера представления надстройки</h2>
<p>Поскольку надстройка реализуется как подкласс <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.windows.frameworkelement">FrameworkElement</a> тип, представление надстройки также должно быть подклассом <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.windows.frameworkelement">FrameworkElement</a>. Ниже показано представление надстройки контракта, реализованное как <code>WPFAddInView</code> класса.</p>
<pre><code class="lang-csharp" name="SimpleAddInIsAUISample#AddInViewCode">using System.AddIn.Pipeline;
using System.Windows.Controls;

namespace AddInViews
{
    /// &lt;summary&gt;
    /// Defines the add-in's view of the contract.
    /// &lt;/summary&gt;
    [AddInBase]
    public class WPFAddInView : UserControl { }
}
</code></pre>
<p>Здесь представление надстройки является производным от <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.windows.controls.usercontrol">UserControl</a>. Следовательно, пользовательского интерфейса надстройки также должен быть производным от <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.windows.controls.usercontrol">UserControl</a>.</p>
<p><a name="AddInSideAdapter"></a></p>
<h2 id="implementing-the-add-in-side-adapter-pipeline-segment">Реализация сегмента конвейера адаптера надстройки</h2>
<p>Контракт — <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.addin.contract.inativehandlecontract">INativeHandleContract</a>, надстройка — <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.windows.frameworkelement">FrameworkElement</a> (как указано в сегменте конвейера представления надстройки). Таким образом <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.windows.frameworkelement">FrameworkElement</a> должны быть преобразованы в <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.addin.contract.inativehandlecontract">INativeHandleContract</a> перед пересечением границы изоляции. Эту работу выполняет адаптер стороне надстройки, вызвав <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.addin.pipeline.frameworkelementadapters.viewtocontractadapter">ViewToContractAdapter</a>, как показано в следующем коде.</p>
<pre><code class="lang-csharp" name="SimpleAddInIsAUISample#AddInSideAdapterCode">using System;
using System.AddIn.Contract;
using System.AddIn.Pipeline;
using System.Security.Permissions;

using AddInViews;
using Contracts;

namespace AddInSideAdapters
{
    /// &lt;summary&gt;
    /// Adapts the add-in's view of the contract to the add-in contract
    /// &lt;/summary&gt;
    [AddInAdapter]
    public class WPFAddIn_ViewToContractAddInSideAdapter : ContractBase, IWPFAddInContract
    {
        WPFAddInView wpfAddInView;

        public WPFAddIn_ViewToContractAddInSideAdapter(WPFAddInView wpfAddInView)
        {
            // Adapt the add-in view of the contract (WPFAddInView)
            // to the contract (IWPFAddInContract)
            this.wpfAddInView = wpfAddInView;
        }

        /// &lt;summary&gt;
        /// ContractBase.QueryContract must be overridden to:
        /// * Safely return a window handle for an add-in UI to the host
        ///   application's application.
        /// * Enable tabbing between host application UI and add-in UI, in the
        ///   &quot;add-in is a UI&quot; scenario.
        /// &lt;/summary&gt;
        public override IContract QueryContract(string contractIdentifier)
        {
            if (contractIdentifier.Equals(typeof(INativeHandleContract).AssemblyQualifiedName))
            {
                return FrameworkElementAdapters.ViewToContractAdapter(this.wpfAddInView);
            }

            return base.QueryContract(contractIdentifier);
        }

        /// &lt;summary&gt;
        /// GetHandle is called by the WPF add-in model from the host application's
        /// application domain to get the window handle for an add-in UI from the
        /// add-in's application domain. GetHandle is called if a window handle isn't
        /// returned by other means ie overriding ContractBase.QueryContract,
        /// as shown above.
        /// NOTE: This method requires UnmanagedCodePermission to be called
        ///       (full-trust by default), to prevent illegal window handle
        ///       access in partially trusted scenarios. If the add-in could
        ///       run in a partially trusted application domain
        ///       (eg AddInSecurityLevel.Internet), you can safely return a window
        ///       handle by overriding ContractBase.QueryContract, as shown above.
        /// &lt;/summary&gt;
        [SecurityPermissionAttribute(SecurityAction.Demand, Flags = SecurityPermissionFlag.UnmanagedCode)]
        public IntPtr GetHandle()
        {
            return FrameworkElementAdapters.ViewToContractAdapter(this.wpfAddInView).GetHandle();
        }
    }
}
</code></pre>
<p>В модели надстройки, где надстройка возвращает пользовательский Интерфейс (см. в разделе <a href="how-to-create-an-add-in-that-returns-a-ui.html">создание надстройки, возвращающей пользовательский Интерфейс</a>), преобразовать адаптер надстройки <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.windows.frameworkelement">FrameworkElement</a> для <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.addin.contract.inativehandlecontract">INativeHandleContract</a> путем вызова <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.addin.pipeline.frameworkelementadapters.viewtocontractadapter">ViewToContractAdapter</a>. <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.addin.pipeline.frameworkelementadapters.viewtocontractadapter">ViewToContractAdapter</a> также должен вызываться в этой модели, несмотря на то, что вам нужно реализовать метод, с которым следует записывать код для его вызова. Это делается путем переопределения <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.addin.pipeline.contractbase.querycontract">QueryContract</a> и реализация кода, который вызывает <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.addin.pipeline.frameworkelementadapters.viewtocontractadapter">ViewToContractAdapter</a> Если код, который вызывает <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.addin.pipeline.contractbase.querycontract">QueryContract</a> ожидает <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.addin.contract.inativehandlecontract">INativeHandleContract</a>. В этом случае вызывающий объект будет адаптером приложения, который рассматривается в следующем подразделе.</p>
<div class="NOTE">
<h5>Note</h5>
<p>Необходимо также переопределить <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.addin.pipeline.contractbase.querycontract">QueryContract</a> в этой модели, чтобы разрешить переходы между ведущим приложением пользовательский Интерфейс и интерфейс пользователя надстройки. Дополнительные сведения см. в разделе «Add-In ограничения WPF» в <a href="wpf-add-ins-overview.html">Общие сведения о надстройках WPF</a>.</p>
</div>
<p>Так как адаптер на стороне надстройки реализует интерфейс, который является производным от <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.addin.contract.inativehandlecontract">INativeHandleContract</a>, необходимо также реализовать <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.addin.contract.inativehandlecontract.gethandle">GetHandle</a>, несмотря на то, что этот параметр игнорируется при <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.addin.pipeline.contractbase.querycontract">QueryContract</a> переопределяется.</p>
<p><a name="HostViewPipeline"></a></p>
<h2 id="implementing-the-host-view-pipeline-segment">Реализация сегмента конвейера представления в основном приложении</h2>
<p>В этой модели ведущее приложение обычно ожидает, что хост-представление, быть <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.windows.frameworkelement">FrameworkElement</a> подкласс. Адаптер необходимо преобразовать <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.addin.contract.inativehandlecontract">INativeHandleContract</a> для <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.windows.frameworkelement">FrameworkElement</a> после <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.addin.contract.inativehandlecontract">INativeHandleContract</a> пересекает границу изоляции. Поскольку метод не вызывается ведущим приложением для получения <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.windows.frameworkelement">FrameworkElement</a>, представления главного приложения должно «вернуть» <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.windows.frameworkelement">FrameworkElement</a> , включая его. Следовательно, представление главного приложения должен быть производным от подкласс <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.windows.frameworkelement">FrameworkElement</a> , могут содержать другие UI, такие как <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.windows.controls.usercontrol">UserControl</a>. Ниже показано представление узла контракта, реализованное как <code>WPFAddInHostView</code> класса.</p>
<p><a name="HostSideAdapter"></a></p>
<h2 id="implementing-the-host-side-adapter-pipeline-segment">Реализация сегмента конвейера адаптера приложения</h2>
<p>Контракт — <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.addin.contract.inativehandlecontract">INativeHandleContract</a>, а ведущее приложение ожидает <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.windows.controls.usercontrol">UserControl</a> (как указано представлением узла). Следовательно <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.addin.contract.inativehandlecontract">INativeHandleContract</a> должны быть преобразованы в <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.windows.frameworkelement">FrameworkElement</a> после пересечения границы изоляции и перед заданием в качестве содержимого представления в ведущем приложении (который является производным от <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.windows.controls.usercontrol">UserControl</a>).</p>
<p>Эту работу выполняет адаптер приложения, как показано в следующем коде.</p>
<p>Как видите, адаптер получает <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.addin.contract.inativehandlecontract">INativeHandleContract</a> путем вызова адаптер на стороне надстройки <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.addin.pipeline.contractbase.querycontract">QueryContract</a> метода (именно на этом этапе где <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.addin.contract.inativehandlecontract">INativeHandleContract</a> пересекает границу изоляции).</p>
<p>Адаптер, затем преобразует <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.addin.contract.inativehandlecontract">INativeHandleContract</a> для <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.windows.frameworkelement">FrameworkElement</a> путем вызова <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.addin.pipeline.frameworkelementadapters.contracttoviewadapter">ContractToViewAdapter</a>. Наконец <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.windows.frameworkelement">FrameworkElement</a> задается как содержимое представления главного приложения.</p>
<p><a name="AddIn"></a></p>
<h2 id="implementing-the-add-in">Реализация надстройки</h2>
<p>При наличии адаптера надстройки и представления надстройки можно реализовать надстройку, производя ее от представления надстройки, как показано в следующем коде.</p>
<p>В этом примере можно увидеть одно любопытное преимущество данной модели: разработчикам должны реализовать только надстройку (поскольку это пользовательский интерфейс), а не класс надстройки и пользовательского интерфейса надстройки.</p>
<p><a name="HostApp"></a></p>
<h2 id="implementing-the-host-application">Реализация ведущего приложения</h2>
<p>Адаптер на стороне узла и созданного представления узла, ведущее приложение может использовать .NET Framework в модели надстройки, чтобы открыть конвейер и получить серверное представление надстройки. Эти действия показаны в следующем коде.</p>
<p>Ведущее приложение использует типичный код модели надстроек платформы .NET Framework для активации надстройки, которая неявным образом возвращает представление главного приложения ведущим приложением. Ведущее приложение затем отображает представление главного приложения (который является <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.windows.controls.usercontrol">UserControl</a>) из <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.windows.controls.grid">Grid</a>.</p>
<p>Код для обработки взаимодействия с помощью пользовательского интерфейса выполняется в домен приложения надстройки. Эти взаимодействия включают следующее.</p>
<ul>
<li><p>Обработка <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.windows.controls.button">Button</a><a class="xref" href="https://docs.microsoft.com/dotnet/api/system.windows.controls.primitives.buttonbase.click">Click</a> событий.</p>
</li>
<li><p>Отображение <a class="xref" href="https://docs.microsoft.com/dotnet/api/system.windows.messagebox">MessageBox</a>.</p>
</li>
</ul>
<p>Это действие полностью изолировано от ведущего приложения.</p>
<h2 id="see-also">См. также</h2>
<ul>
<li><a href="/previous-versions/dotnet/netframework-4.0/bb384200(v%3dvs.100)">Надстройки и расширения среды</a></li>
<li><a href="wpf-add-ins-overview.html">Общие сведения о надстройках WPF</a></li>
</ul>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            <span><a href="https://github.com/MSDN-WhiteKnight/dotnet-docs-ru">Неофициальная документация по .NET на русском языке</a>. Лицензия: <a href="https://github.com/MSDN-WhiteKnight/dotnet-docs-ru/blob/main/LICENSE">CC-BY 4.0</a>. Основано на <a href="https://docs.microsoft.com/ru-ru/dotnet/">документации по .NET с Microsoft Docs</a><br>Generated by <strong>DocFX</strong></span><script type="text/javascript">(function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})(window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");ym(65150713, "init", {clickmap:true,trackLinks:true,accurateTrackBounce:true});</script><noscript><div><img src="https://mc.yandex.ru/watch/65150713" style="position:absolute; left:-9999px;" alt=""></div></noscript>
            
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../../styles/main.js"></script>
  </body>
</html>
