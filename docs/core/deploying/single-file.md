---
title: Приложение с одним файлом
description: Узнайте, что такое приложение с одним файлом и зачем нужно использовать эту модель развертывания приложения.
author: lakshanf
ms.author: lakshanf
ms.date: 12/17/2020
ms.openlocfilehash: fb768fa6fe390fbe8390e441f4eb71c3172ad395
ms.sourcegitcommit: f2ab02d9a780819ca2e5310bbcf5cfe5b7993041
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/03/2021
ms.locfileid: "99505430"
---
# <a name="single-file-deployment-and-executable"></a>Развертывание и выполнение в виде отдельного файла

Объединение всех зависящих от приложения файлов в один двоичный файл предоставляет разработчику приложения привлекательный вариант развертывания и распространения приложения в виде одного файла. Эта модель развертывания была доступна с момента выпуска .NET Core 3.0 и улучшена в .NET 5.0. Ранее в .NET Core 3.0, когда пользователь запускал приложение с одним файлом, узел .NET Core перед запуском приложения сначала извлекал все файлы во временный каталог. В .NET 5.0 этот подход был улучшен, позволяя запускать код напрямую без необходимости извлекать файлы из приложения.

Развертывание в одном файле доступно как для [зависимой от платформы модели развертывания](index.md#publish-framework-dependent), так и для [автономных приложений](index.md#publish-self-contained). Размер одного файла для автономного приложения будет большим, так как он будет включать в себя среду выполнения и библиотеки платформы. Вариант развертывания в виде одного файла можно сочетать с параметрами публикации [ReadyToRun](ready-to-run.md) и [Обрезка (экспериментальная функция в .NET 5.0)](trim-self-contained.md).

## <a name="api-incompatibility"></a>Несовместимость API

Некоторые API несовместимы с моделью развертывания с одним файлом. Поэтому, возможно, потребуется изменить приложения, если они используют такие API. Если вы работаете со сторонними платформами или пакетами, возможно, они также используют один из таких API и требуют изменения. Распространенная причина многих проблем — это зависимость от путей к файлам или библиотекам DLL, поставляемых с приложением.

В таблице ниже приведены соответствующие сведения об API библиотеки среды выполнения для использования с одним файлом.

| API                            | Примечание                                                                   |
|--------------------------------|------------------------------------------------------------------------|
| `Assembly.Location`            | Возвращает пустую строку.                                               |
| `Module.FullyQualifiedName`    | Возвращает строку со значением `<Unknown>` или вызывает исключение. |
| `Module.Name`                  | Возвращает строку со значением `<Unknown>`.                        |
| `Assembly.GetFile`             | Выдает исключение <xref:System.IO.IOException>.                                   |
| `Assembly.GetFiles`            | Выдает исключение <xref:System.IO.IOException>.                                   |
| `Assembly.CodeBase`            | Выдает исключение <xref:System.PlatformNotSupportedException>.                    |
| `Assembly.EscapedCodeBase`     | Выдает исключение <xref:System.PlatformNotSupportedException>.                    |
| `AssemblyName.CodeBase`        | Возвращает `null`.                                                        |
| `AssemblyName.EscapedCodeBase` | Возвращает `null`.                                                        |

Вот некоторые рекомендации по исправлению для распространенных сценариев:

* Чтобы получить доступ к файлам, расположенным рядом с исполняемым файлом, используйте <xref:System.AppContext.BaseDirectory?displayProperty=nameWithType>.

* Чтобы найти имя исполняемого файла, используйте первый элемент метода <xref:System.Environment.GetCommandLineArgs?displayProperty=nameWithType>.

* Чтобы не допустить доставку свободных файлов в целом, используйте [внедренные ресурсы](../../framework/resources/creating-resource-files-for-desktop-apps.md).

## <a name="attaching-a-debugger"></a>Подключение отладчика

В Linux [SOS с LLDB](../diagnostics/dotnet-sos.md) — это единственный отладчик, который может подключаться к автономным процессам с одним файлом или выполнять отладку аварийных дампов.

В Windows и Mac для отладки аварийных дампов можно использовать Visual Studio и VS Code. Для подключения к исполняемому файлу выполняемого автономного приложения с одним файлом требуется дополнительный файл: _mscordbi.{dll,so}_ .

При отсутствии этого файла Visual Studio может выдать сообщение об ошибке, информирующее о том, что не удается присоединиться к процессу, так как установлен компонент отладки. VS Code выдать сообщение об ошибке, информирующее о том, что не удается присоединиться к процессу из-за неизвестной ошибки 0x80131c3c.

Чтобы устранить эти ошибки, нужно скопировать _mscordbi_ и вставить рядом с исполняемым файлом. По умолчанию файл _mscordbi_ обработан с помощью `publish` в подкаталоге с идентификатором среды выполнения приложения. Например, если бы нужно было опубликовать исполняемый файл автономного приложения с одним файлом, используя CLI `dotnet` для Windows и параметры `-r win-x64`, файл следовало бы поместить в папку _bin/Debug/net5.0/win-x64/publish_. Копия _mscordbi.dll_ будет находиться в папке _bin/debug/NET 5.0/Win-x64_.

## <a name="other-considerations"></a>Другие замечания

По умолчанию один файл не включает собственные библиотеки. В Linux предварительно связывается среда выполнения с пакетом, а в каталоге, в котором размещается приложение с одним файлом, развертываются только собственные библиотеки приложения. В Windows предварительно связывается только код размещения, а в каталоге, в котором размещается приложение с одним файлом, развертываются как библиотеки среды выполнения, так и собственные библиотеки приложения. Это позволяет обеспечить эффективную отладку, для которой требуется, чтобы собственные файлы были исключены из одного файла. Можно задать флаг `IncludeNativeLibrariesForSelfExtract`, чтобы включить собственные библиотеки в один пакет, но эти файлы будут извлечены во временный каталог на клиентском компьютере при запуске приложения с одним файлом.

При указании `IncludeAllContentForSelfExtract` будут извлечены все файлы перед запуском исполняемого файла. Это позволяет сохранить исходное поведение развертывания одного файла в .NET Core.

Все связанные PDB-файлы будут храниться рядом с приложением с одним файлом, и они не будут упакованы по умолчанию. Если нужно включить PDB-файлы в сборку для компилируемых проектов, задайте для `DebugType` значение `embedded`, как описано [ниже](#include-pdb-files-inside-the-bundle).

Управляемые компоненты C++ не подходят для развертывания с одним файлом. Поэтому рекомендуется писать приложения на C# или другом неуправляемом языке на базе C++, если требуется совместимость с развертыванием в одном файле.

## <a name="exclude-files-from-being-embedded"></a>Исключить файлы из внедрения

Некоторые файлы можно явно исключить из внедрения в один файл, установив следующие метаданные.

```xml
<ExcludeFromSingleFile>true</ExcludeFromSingleFile>
```

Например, чтобы поместить некоторые файлы в каталог публикации, но не объединять их в один файл, укажите следующие параметры.

```xml
<ItemGroup>
  <Content Update="Plugin.dll">
    <CopyToPublishDirectory>PreserveNewest</CopyToPublishDirectory>
    <ExcludeFromSingleFile>true</ExcludeFromSingleFile>
  </Content>
</ItemGroup>
```

## <a name="include-pdb-files-inside-the-bundle"></a>Добавление PDB-файлов в пакет

PDB-файл для сборки можно внедрить в саму сборку (`.dll`), используя параметр, приведенный ниже. Так как символы являются частью сборки, они также будут частью приложения с одним файлом:

```xml
<DebugType>embedded</DebugType>
```

Например, добавьте следующее свойство в файл проекта сборки, чтобы внедрить PDB-файл в эту сборку:

```xml
<PropertyGroup>
  <DebugType>embedded</DebugType>
</PropertyGroup>
```

## <a name="publish-a-single-file-app---sample-project-file"></a>Публикация приложения с одним файлом — пример файла проекта

Ниже приведен пример файла проекта, в котором задана публикация одного файла:

```xml
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <OutputType>Exe</OutputType>
    <TargetFramework>net5.0</TargetFramework>
    <PublishSingleFile>true</PublishSingleFile>
    <SelfContained>true</SelfContained>
    <RuntimeIdentifier>win-x64</RuntimeIdentifier>
    <PublishTrimmed>true</PublishTrimmed>
    <PublishReadyToRun>true</PublishReadyToRun>
  </PropertyGroup>

</Project>
```

Эти свойства имеют следующие функции:

* `PublishSingleFile` — включение однофайловой публикации.
* `SelfContained` — определение того, будет ли приложение автономным или зависимым от платформы.
* `RuntimeIdentifier` — указание [типа операционной системы и ЦП](../rid-catalog.md), для которых предназначено приложение.
* `PublishTrimmed` — разрешение использования [усечения сборки](trim-self-contained.md), которое поддерживается только для автономных приложений.
* `PublishReadyToRun` — включение [компиляции AOT](ready-to-run.md).

**Примечания.**

* Приложения создаются для определенной ОС и архитектуры. Необходимо опубликовать приложение для каждой конфигурации, например Linux x64, Linux ARM64, Windows x64 и т. д.
* Файлы конфигурации, такие как *\*.runtimeconfig.json*, включаются в один файл. Если требуется дополнительный файл конфигурации, его можно поместить вместе с одним файлом приложения.

## <a name="publish-a-single-file-app---cli"></a>Публикация приложения с одним файлом с помощью CLI

Опубликуйте приложение с одним файлом с помощью команды [dotnet publish](../tools/dotnet-publish.md). При публикации приложения задайте следующие свойства.

- Опубликовать для конкретной среды выполнения: `-r win-x64`
- Опубликовать в виде одного файла: `-p:PublishSingleFile=true`

В следующем примере приложение для Windows публикуется как автономное приложение с одним файлом.

```dotnetcli
dotnet publish -r win-x64 -p:PublishSingleFile=true --self-contained true
```

В следующем примере приложение для Linux публикуется как зависимое от платформы приложение с одним файлом.

```dotnetcli
dotnet publish -r linux-x64 -p:PublishSingleFile=true --self-contained false
```

Дополнительные сведения см. в статье [Публикация приложений .NET Core с помощью .NET Core CLI](deploy-with-cli.md).

## <a name="publish-a-single-file-app---visual-studio"></a>Публикация приложения с одним файлом с помощью Visual Studio

Visual Studio создает многократно используемые профили публикации, которые управляют процессом публикации приложения.

01. В **обозревателе решений** щелкните правой кнопкой мыши проект, который нужно опубликовать. Нажмите кнопку **Опубликовать**.

    :::image type="content" source="media/single-file/visual-studio-solution-explorer.png" alt-text="Обозреватель решений с контекстным меню, где выделен пункт Опубликовать":::

    Если у вас еще нет профиля публикации, следуйте инструкциям по его созданию и выберите **Папка** в качестве типа целевого объекта.

01. Нажмите кнопку **Изменить**.

    :::image type="content" source="media/single-file/visual-studio-publish-edit-settings.png" alt-text="Профиль публикации Visual Studio с кнопкой Изменить":::

01. В диалоговом окне **Параметры профиля** задайте следующие параметры.

    - Параметру **Режим развертывания** задайте значение **Автономное** или **Зависимое от платформы**.
    - В качестве значения параметра **Целевая среда выполнения** укажите платформу, на которую будет выполнена публикация. (Значение должно быть отличным от **Переносимый**.)
    - Выберите **Создать отдельный файл**.

    Нажмите кнопку **Сохранить**, чтобы сохранить параметры и вернуться в диалоговое окно **Публикация**.

    :::image type="content" source="media/single-file/visual-studio-publish-single-file-properties.png" alt-text="Диалоговое окно параметров профиля с выделенными параметрами для режима развертывания, целевой среды выполнения и создания отдельного файла":::

01. Чтобы опубликовать приложение с одним файлом, нажмите кнопку **Опубликовать**.

Дополнительные сведения см. в статье [Публикация приложений .NET Core с помощью Visual Studio](deploy-with-vs.md).

## <a name="publish-a-single-file-app---visual-studio-for-mac"></a>Публикация приложения с одним файлом с помощью Visual Studio для Mac

В Visual Studio для Mac отсутствует возможность публикации приложения в виде одного файла. Вам потребуется опубликовать приложение вручную, выполнив инструкции из раздела [Публикация приложения с одним файлом с помощью CLI](#publish-a-single-file-app---cli). Дополнительные сведения см. в статье [Публикация приложений .NET Core с помощью .NET Core CLI](deploy-with-cli.md).

## <a name="see-also"></a>См. также

- [Развертывание приложений .NET Core](index.md)
- [Публикация приложений .NET Core с помощью .NET Core CLI](deploy-with-cli.md)
- [Публикация приложений .NET Core с помощью Visual Studio](deploy-with-vs.md)
- [Команда `dotnet publish`](../tools/dotnet-publish.md).
