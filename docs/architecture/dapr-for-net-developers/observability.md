---
title: Стандартный блок наблюдаемых ДАПР
description: Описание стандартного блока наблюдаемых элементов, его функций, преимуществ и способов его применения
author: edwinvw
ms.date: 02/07/2021
ms.reviewer: robvet
ms.openlocfilehash: c7c941625f5867ad58eee602bfc42183bee87183
ms.sourcegitcommit: 42d436ebc2a7ee02fc1848c7742bc7d80e13fc2f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/04/2021
ms.locfileid: "102401871"
---
# <a name="the-dapr-observability-building-block"></a>Стандартный блок наблюдаемых ДАПР

Современные распределенные системы являются сложными. Начнем с небольших, слабо связанных и независимо развертываемых служб. Эти службы перекрестно обрабатывают границы серверов. Затем они используют различные виды резервных служб инфраструктуры (базы данных, брокеры сообщений, хранилища ключей). Наконец, эти разнородные части соформируют приложение.

Так как вы будете иметь представление о том, что происходит? К сожалению, устаревшие подходы к мониторингу не достаточно. Вместо этого система должна быть **наблюдаемой** от начала до конца. Современные методики [наблюдения](../cloud-native/observability-patterns.md) обеспечивают наглядное представление о работоспособности приложения. Они позволяют определить внутреннее состояние, просматривая выходные данные. Наблюдаемость является обязательной для мониторинга и устранения неполадок распределенных приложений.

Сведения о системе, используемые для получения наблюдаемых сведений, называются **телеметрии**. Его можно разделить на четыре основные категории:

1. **Распределенная трассировка** позволяет понять трафик между службами и службами, вовлеченными в распределенные транзакции.
1. **Метрики** позволяют понять производительность службы и ее потребление ресурсов.
1. **Ведение журнала** позволяет получить представление о том, как работает код, и при возникновении ошибок.
1. Конечные точки **работоспособности** позволяют получить представление о доступности службы.

Глубина телеметрии определяется функциями наблюдаемой платформы приложения. Рассмотрим облако Azure. Он предоставляет широкие возможности телеметрии, включая все категории телеметрии. Без какой бы то ни было конфигурации Большинство служб Azure IaaS и PaaS распространяют и публикуют данные телеметрии в службе [Application Insights Azure](/azure/azure-monitor/app/app-insights-overview) . Application Insights представляет области ведения журнала системы, отслеживания и проблем с высокой визуальной панелью мониторинга. Она может даже визуализировать схему, показывающую зависимости между службами на основе их взаимодействия.

Но что делать, если приложение не может использовать Azure PaaS и ресурсы IaaS? Можно ли по-прежнему использовать широкие возможности телеметрии Application Insights? Ответ — Да. Приложение, не являющееся приложением Azure, может импортировать библиотеки, добавлять конфигурацию и инструментировать код для отправки телеметрии в Azure Application Insights. Однако этот подход **тесно связывает** приложение с Application Insights. Перемещение приложения на другую платформу мониторинга может привести к дорогостоящему рефакторингу. Было бы неплохо избегать тесного связывания и использования наблюдаемых данных за пределами кода?

С помощью ДАПР можно. Рассмотрим, как ДАПР может добавить наблюдаемые возможности в распределенные приложения.

## <a name="what-it-solves"></a>Решение

Стандартный блок наблюдаемости ДАПР разделяет наблюдаемость из приложения. Он автоматически захватывает трафик, созданный ДАПР сидекарс и ДАПР системными службами, которые составляют плоскость управления ДАПР. Блок корреляции трафика от одной операции, охватывающей несколько служб. Он также предоставляет метрики производительности, использование ресурсов и работоспособность системы. Данные телеметрии публикуются в формате с открытым стандартом, позволяя получать информацию в серверной части мониторинга. Там можно выполнять визуализацию, запрос и анализ данных.

По мере того, как ДАПР абстрагирует процесс, приложение не знает, как реализована наблюдаемость. Нет необходимости ссылаться на библиотеки или реализовывать пользовательский код инструментирования. ДАПР позволяет разработчику сосредоточиться на построении бизнес-логики, а не на контролируемости. Наблюдаемость настраивается на уровне ДАПР и согласована между службами, даже если она создана различными командами и построена с различными технологическими стеками.

## <a name="how-it-works"></a>Принцип работы

[Архитектура расширения](dapr-at-20000-feet.md#sidecar-architecture) ДАПР обеспечивает встроенные функции наблюдения. При взаимодействии служб ДАПР сидекарс перехватывает трафик и извлекает данные трассировки, метрики и ведения журнала. Данные телеметрии публикуются в формате Open Standard. По умолчанию ДАПР поддерживает [опентелеметри](https://opentelemetry.io/) и [зипкин](https://zipkin.io/).

ДАПР предоставляет средства сбора данных, которые могут публиковать [данные](https://docs.dapr.io/operations/monitoring/open-telemetry-collector/) телеметрии для различных средств мониторинга серверной части. Эти средства представляют данные телеметрии ДАПР для анализа и запросов. На рис. 9-1 показана архитектура наблюдаемых ДАПР:

![Архитектура наблюдаемых ДАПР](media/observability/observability-architecture.png)

**Рис. 9-1**. Архитектура наблюдаемой ДАПР.

1. Служба а вызывает операцию в службе B. Вызов направляется от ДАПР расширения для службы A в расширения для службы б.
1. Когда служба б завершает операцию, ответ отправляется обратно службе A через сидекарс ДАПР. Они собирают и публикуют все доступные данные телеметрии для каждого запроса и ответа.
1. Настроенный сборщик принимает данные телеметрии и отправляет его в серверную части мониторинга.  

В качестве разработчика следует помнить, что добавление наблюдаемой среды отличается от настройки других стандартных блоков ДАПР, таких как публикация и подстройка или управление состоянием. Вместо ссылки на стандартный блок необходимо добавить сборщик и серверную часть мониторинга. На рис. 9-1 показано, как можно настроить несколько средств для объединения с разными серверными элементами мониторинга.

В начале этой главы была обнаружена четыре категории телеметрии. В следующих разделах приводятся подробные сведения о каждой категории. Они включают инструкции по настройке средств для собраний, которые интегрируются с популярными серверными элементами мониторинга.

### <a name="distributed-tracing"></a>Распределенная трассировка

Распределенная трассировка позволяет понять трафик, который передается между службами в распределенном приложении. Журнал обменных сообщений запросов и ответов является ценным источником сведений для устранения неполадок. Жесткая часть представляет собой *корреляцию сообщений* , происходящих из одной операции.

ДАПР использует [контекст трассировки W3C](https://www.w3.org/TR/trace-context) для корреляции связанных сообщений. Он внедряет в запросы и ответы те же сведения о контексте, которые формируют уникальную операцию. На рис. 9-2 показано, как работает корреляция.

![Пример контекста трассировки W3C](media/observability/w3c-trace-context.png)

**Рис. 9-2**. Пример контекста трассировки W3C.

1. Служба а вызывает операцию в службе B. Когда служба а запускает вызов, ДАПР создает уникальный контекст трассировки и внедряет его в запрос.
1. Служба б получает запрос и вызывает операцию в службе C. ДАПР обнаруживает, что входящий запрос содержит контекст трассировки и распространяет его, добавляя его в исходящий запрос в службу C.  
1. Служба C получает запрос и обрабатывает его. ДАПР обнаруживает, что входящий запрос содержит контекст трассировки и распространяет его, добавляя его в исходящий ответ обратно в службу B.
1. Служба б получает ответ и обрабатывает его. Затем он создает новый ответ и распространяет контекст трассировки, внедряя его в исходящий ответ обратно в службу A.

Набор запросов и ответов, входящих в состав, называется *трассировкой*. На рис. 9-3 показана трассировка:

![Трассировки и охваты](media/observability/traces-spans.png)

**Рис. 9-3**. Трассировки и охваты.

На рисунке обратите внимание, что трассировка представляет собой уникальную транзакцию приложения, которая выполняется во многих службах. Трассировка — это коллекция *диапазонов*. Каждый диапазон представляет одну операцию или единицу работы, выполняемую в трассировке. Диапазоны — это запросы и ответы, которые передаются между службами, которые реализуют уникальную транзакцию.

В следующих разделах описано, как проверить данные телеметрии трассировки, опубликовав их в серверной части мониторинга.

#### <a name="use-a-zipkin-monitoring-back-end"></a>Использование серверной части Зипкин Monitoring

[Зипкин](https://zipkin.io/) — это распределенная система трассировки с открытым исходным кодом. Он может принимать и визуализировать данные телеметрии. ДАПР предлагает поддержку по умолчанию для Зипкин. В следующем примере показано, как настроить Зипкин для визуализации телеметрии ДАПР.

##### <a name="enable-and-configure-tracing"></a>Включение и Настройка трассировки

Для начала трассировка должна быть включена для среды выполнения ДАПР с помощью файла конфигурации ДАПР. Ниже приведен пример файла конфигурации с именем `tracing-config.yaml` .  

```yaml
apiVersion: dapr.io/v1alpha1
kind: Configuration
metadata:
  name: tracing-config
  namespace: default
spec:
  tracing:
    samplingRate: "1"
    zipkin:
      endpointAddress: "http://zipkin.default.svc.cluster.local:9411/api/v2/spans"
```

`samplingRate`Атрибут задает интервал, используемый для публикации трассировок. Значение должно находиться в диапазоне `0` (трассировка отключена) и `1` (Каждая трассировка опубликована). При значении, например, `0.5` каждая другая трассировка публикуется, значительно уменьшая опубликованный трафик. `endpointAddress`Указывает на конечную точку на сервере зипкин, работающем в кластере Kubernetes. Портом по умолчанию для Зипкин является `9411` . Конфигурация должна быть применена к кластеру Kubernetes с помощью интерфейса командной строки Kubernetes:

```console
kubectl apply -f tracing-config.yaml
```

##### <a name="install-the-zipkin-server"></a>Установка сервера Зипкин

При установке ДАПР в режиме, размещенном в локальной среде, сервер Зипкин устанавливается автоматически, а трассировка включается в файле конфигурации по умолчанию, расположенном в `$HOME/.dapr/config.yaml` или `%USERPROFILE%\.dapr\config.yaml` в Windows.

Однако при установке ДАПР в кластере Kubernetes Зипкин не добавляется по умолчанию. Следующий файл манифеста Kubernetes с именем `zipkin.yaml` развертывает Стандартный сервер зипкин в кластере:

```yaml
kind: Deployment
apiVersion: apps/v1
metadata:
  name: zipkin
  namespace: eshop
  labels:
    service: zipkin
spec:
  replicas: 1
  selector:
    matchLabels:
      service: zipkin
  template:
    metadata:
      labels:
        service: zipkin
    spec:
      containers:
        - name: zipkin
          image: openzipkin/zipkin-slim
          imagePullPolicy: IfNotPresent
          ports:
            - name: http
              containerPort: 9411
              protocol: TCP

---

kind: Service
apiVersion: v1
metadata:
  name: zipkin
  namespace: eshop
  labels:
    service: zipkin
spec:
  type: NodePort
  ports:
    - port: 9411
      targetPort: 9411
      nodePort: 32411
      protocol: TCP
      name: zipkin
  selector:
    service: zipkin

```

В развертывании используется стандартный `openzipkin/zipkin-slim` образ контейнера. Служба Зипкин предоставляет интерфейс веб-интерфейса Зипкин, который можно использовать для просмотра данных телеметрии по порту `32411` . Используйте интерфейс командной строки Kubernetes, чтобы применить файл манифеста Зипкин к кластеру Kubernetes и развернуть сервер Зипкин:

```console
kubectl apply -f zipkin.yaml
```

##### <a name="configure-the-services-to-use-the-tracing-configuration"></a>Настройка служб для использования конфигурации трассировки

Теперь все настроено правильно, чтобы начать публикацию телеметрии. Каждый ДАПР расширения, развернутый в составе приложения, должен давать инструкции по выпуску телеметрии при запуске. Для этого добавьте `dapr.io/config` заметку, которая ссылается на `tracing-config` конфигурацию для развертывания каждой службы. Ниже приведен пример файла манифеста службы API Ешоп Ordering, содержащего заметку:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ordering-api
  namespace: eshop
  labels:
    app: eshop
spec:
  replicas: 1
  selector:
    matchLabels:
      app: eshop
  template:
    metadata:
      labels:
        app: simulation
      annotations:
        dapr.io/enabled: "true"
        dapr.io/app-id: "ordering-api"
        dapr.io/config: "tracing-config"
    spec:
      containers:
      - name: simulation
        image: eshop/ordering.api:linux-latest
```

##### <a name="inspect-the-telemetry-in-zipkin"></a>Проверка телеметрии в Зипкин

После запуска приложения ДАПР сидекарс выдаст данные телеметрии на сервер Зипкин. Чтобы проверить эту телеметрию, укажите в веб-браузере <http://localhost:32411> . Вы увидите веб-интерфейс Зипкин:

![Начальная страница Зипкин](media/observability/zipkin.png)

На вкладке *найти трассировку* можно выполнять запросы к трассировкам. При нажатии кнопки *выполнить запрос* без указания каких бы то ни было ограничений будут показаны все полученные *трассировки*:

![Список трассировок](media/observability/zipkin-traces-overview.png)

При нажатии кнопки « *Показывать* » рядом с определенной трассировкой отображаются подробные сведения об этой трассировке:

![Сведения о трассировке](media/observability/zipkin-trace-details.png)

Каждый элемент на странице сведений — это диапазон, представляющий запрос, который является частью выбранной трассировки.

##### <a name="inspect-the-dependencies-between-services"></a>Проверка зависимостей между службами

Так как ДАПР сидекарс обрабатывает трафик между службами, Зипкин может использовать данные трассировки для определения зависимостей между службами. Чтобы увидеть это в действии, перейдите на вкладку *зависимости* на веб-странице зипкин и нажмите кнопку с увеличительным стеклом. Зипкин покажет общие сведения о службах и их зависимостях:

![Граф зависимостей в Зипкин](media/observability/zipkin-dependencies.png)

Анимированные точки на линиях между службами представляют запросы и переходят из источника в место назначения. Красная точка указывает на неудачный запрос.

#### <a name="use-a-jaeger-or-new-relic-monitoring-back-end"></a>Использование Жаежер или новой серверной части мониторинга Relic

Помимо Зипкин, другие серверные программы мониторинга также поддерживают прием данных телеметрии с помощью формата Зипкин. [Жаежер](https://www.jaegertracing.io/) — это система трассировки с открытым исходным кодом, созданная технологиями Uber. Он используется для трассировки транзакций между распределенными службами и устранения неполадок в сложных средах микрослужб. [New Relic](https://newrelic.com/) — это платформа наблюдения с *полным стеком* . Он связывает релевантные данные из распределенного приложения, чтобы предоставить полную картину системы. Чтобы испытать их, укажите в `endpointAddress` файле конфигурации ДАПР указатель на жаежер или новый сервер Relic. Ниже приведен пример файла конфигурации, который настраивает ДАПР для отправки данных телеметрии на сервер Жаежер. URL-адрес для Жаежер идентичен URL-адресу для Зипкин. Единственное отличие заключается в том, что используется порт, на котором работает сервер:

 ```yaml
 apiVersion: dapr.io/v1alpha1
 kind: Configuration
 metadata:
   name: tracing-config
   namespace: default
 spec:
   tracing:
     samplingRate: "1"
     zipkin:
       endpointAddress: "http://localhost:9415/api/v2/spans"
 ```

Чтобы испытать новый Relic, укажите конечную точку нового API Relic. Ниже приведен пример файла конфигурации для New Relic:

 ```yaml
apiVersion: dapr.io/v1alpha1
 kind: Configuration
 metadata:
   name: tracing-config
   namespace: default
 spec:
   tracing:
     samplingRate: "1"
     zipkin:
       endpointAddress: "https://trace-api.newrelic.com/trace/v1?Api-Key=<NR-API-KEY>&Data-Format=zipkin&Data-Format-Version=2"
 ```

Дополнительные сведения о том, как их использовать, см. на веб-сайтах Жаежер и New Relic.

### <a name="metrics"></a>Метрики

Метрики позволяют получить представление о производительности и потреблении ресурсов. Внутри ДАПР выпускается обширная коллекция метрик системы и среды выполнения. ДАПР использует [Prometheus](https://prometheus.io/) в качестве стандарта метрики. ДАПР сидекарс и системные службы предоставляют конечную точку метрик по порту `9090` . *Prometheus отхода* вызывает эту конечную точку в предопределенном интервале для сбора метрик. Отходы отправляют значения метрик в серверную части мониторинга. На рис. 9-4 показан процесс отхода:

![Prometheus метрики](media/observability/prometheus-scraper.png)

**Рис. 9-4**. Prometheus метрики.

На приведенном выше рисунке каждая расширения и системная служба предоставляет конечную точку метрики, которая прослушивает порт 9090. Отбракованный объект метрик Prometheus фиксирует метрики каждой конечной точки и публикует их в серверной части мониторинга.  

#### <a name="service-discovery"></a>обнаружение служб;

Может возникнуть вопрос о том, как источнику метрик будет известно, где собираются метрики. Prometheus можно интегрировать с механизмами обнаружения, встроенными в целевые среды развертывания. Например, при выполнении в Kubernetes Prometheus может интегрироваться с API Kubernetes, чтобы найти все доступные Kubernetes ресурсы, работающие в среде.

#### <a name="metrics-list"></a>Список метрик

ДАПР создает большой набор метрик для системных служб ДАПР и их среды выполнения. Некоторые примеры:

| Метрика                                         | Источник | Описание                                                  |
| ---------------------------------------------- | :----: | ------------------------------------------------------------ |
| dapr_operator_service_created_total            | Система | Общее число ДАПР служб, созданных службой оператора ДАПР. |
| dapr_injector_sidecar_injection и requests_total | Система | Общее число запросов введения расширения, полученных службой Sidecar-Injector ДАПР. |
| dapr_placement_runtimes_total                  | Система | Общее число узлов, отправленных в службу размещения ДАПР. |
| dapr_sentry_cert_sign_request_received_total   | Система | Число запросов подписи сертификата (КРСС), полученных службой ДАПР Sentry. |
| dapr_runtime_component_loaded      | Параметры выполнения | Число успешно загруженных компонентов ДАПР.           |
| dapr_grpc_io_server_completed_rpcs | Параметры выполнения | Число вызовов gRPC по методу и состоянию.                    |
| dapr_http_server_request_count     | Параметры выполнения | Количество HTTP-запросов, запущенных на HTTP-сервере.           |
| dapr_http/клиент/sent_bytes        | Параметры выполнения | Общее число байтов, отправленных в тексте запроса (не включая заголовки) HTTP-клиентом. |

Дополнительные сведения о доступных метриках см. в [документации по метрикам ДАПР](https://docs.dapr.io/developing-applications/building-blocks/observability/metrics).

#### <a name="configure-dapr-metrics"></a>Настройка метрик ДАПР

Во время выполнения можно отключить конечную точку коллекции метрик, включив `--enable-metrics=false` аргумент в команду ДАПР. Также можно изменить порт по умолчанию для конечной точки с помощью `--metrics-port 9090` аргумента.

Вы также можете использовать файл конфигурации ДАПР для статического включения или отключения сбора метрик времени выполнения:

```yaml
apiVersion: dapr.io/v1alpha1
kind: Configuration
metadata:
  name: dapr-config
  namespace: eshop
spec:
  tracing:
    samplingRate: "1"
  metric:
    enabled: false
```

#### <a name="visualize-dapr-metrics"></a>Визуализация метрик ДАПР

С помощью Prometheusного средства сбора и публикации метрик в серверной части мониторинга, как вы хотите понять необработанные данные? Популярное средство визуализации для анализа метрик — [Grafana](https://grafana.com/grafana/). С помощью Grafana можно создавать панели мониторинга из доступных метрик. Ниже приведен пример панели мониторинга, отображающей метрики системных служб ДАПР:

![Панель мониторинга Grafana, отображающая метрики системных служб ДАПР](media/observability/grafana-sample.png)

Документация по ДАПР содержит [руководство по установке Prometheus и Grafana](https://docs.dapr.io/operations/monitoring/grafana/).

### <a name="logging"></a>Ведение журнала

Ведение журнала позволяет понять, что происходит со службой во время выполнения. При запуске приложения ДАПР автоматически создает записи журнала из ДАПР сидекарс и системных служб ДАПР. Однако записи в журнале, инструментированные в коде приложения, **не** включаются автоматически. Чтобы выдать журнал из кода приложения, можно импортировать конкретный пакет SDK, например [ОПЕНТЕЛЕМЕТРИ SDK для .NET](https://opentelemetry.io/docs/net/). Код приложения для ведения журнала рассматривается далее в разделе, посвященном *использованию пакета SDK для ДАПР .NET*.  

#### <a name="log-entry-structure"></a>Структура записи журнала

ДАПР выдает структурированное ведение журнала. Каждая запись журнала имеет следующий формат:

| Поле    | Описание                                          | Пример                             |
| -------- | ---------------------------------------------------- | ----------------------------------- |
| time     | Отформатированная метка времени ISO8601                          | `2021-01-10T14:19:31.000Z`          |
| уровень    | Уровень записи ( `debug` \| `info` \| `warn` \| `error` )   | `info`                              |
| type     | Тип журнала                                             | `log`                               |
| msg      | Сообщение журнала                                          | `metrics server started on :62408/` |
| область    | Область ведения журнала                                        | `dapr.runtime`                      |
| экземпляр | Имя узла, где выполняется ДАПР                             | TSTSRV01                            |
| app_id   | Идентификатор приложения ДАПР                                          | ordering-api                        |
| ver      | Версия среды выполнения ДАПР                                 | `1.0.0`-RC. 2                        |

При поиске в записях журнала в сценарии устранения неполадок `time` поля и `level` особенно полезны. Поле времени упорядочивает записи журнала, чтобы можно было определить конкретные периоды времени. При устранении неполадок записи журнала на *уровне отладки* содержат дополнительные сведения о поведении кода.

#### <a name="plain-text-versus-json-format"></a>Обычный текст и формат JSON

По умолчанию ДАПР выдает структурированный журнал в обычном текстовом формате. Каждая запись журнала форматируется как строка, содержащая пары "ключ-значение". Вот пример ведения журнала в виде обычного текста:

```text
== DAPR == time="2021-01-12T16:11:39.4669323+01:00" level=info msg="starting Dapr Runtime -- version 1.0.0-rc.2 -- commit 196483d" app_id=ordering-api instance=TSTSRV03 scope=dapr.runtime type=log ver=1.0.0-rc.2
== DAPR == time="2021-01-12T16:11:39.467933+01:00" level=info msg="log level set to: info" app_id=ordering-api instance=TSTSRV03 scope=dapr.runtime type=log ver=1.0.0-rc.2
== DAPR == time="2021-01-12T16:11:39.467933+01:00" level=info msg="metrics server started on :62408/" app_id=ordering-api instance=TSTSRV03 scope=dapr.metrics type=log ver=1.0.0-rc.2
```

В простой форме этот формат сложно проанализировать. При просмотре записей журнала с помощью средства мониторинга необходимо включить ведение журнала в формате JSON. С помощью записей JSON средство мониторинга может индексировать и запрашивать отдельные поля. Вот те же записи журнала в формате JSON:

```json
{"app_id": "ordering-api", "instance": "TSTSRV03", "level": "info", "msg": "starting Dapr Runtime -- version 1.0.0-rc.2 -- commit 196483d", "scope": "dapr.runtime", "time": "2021-01-12T16:11:39.4669323+01:00", "type": "log", "ver": "1.0.0-rc.2"}
{"app_id": "ordering-api", "instance": "TSTSRV03", "level": "info", "msg": "log level set to: info", "scope": "dapr.runtime", "type": "log", "time": "2021-01-12T16:11:39.467933+01:00", "ver": "1.0.0-rc.2"}
{"app_id": "ordering-api", "instance": "TSTSRV03", "level": "info", "msg": "metrics server started on :62408/", "scope": "dapr.metrics", "type": "log", "time": "2021-01-12T16:11:39.467933+01:00", "ver": "1.0.0-rc.2"}
```

Чтобы включить форматирование JSON, необходимо настроить каждый ДАПР расширения. В режиме автономного размещения можно указать флаг в `--log-as-json` командной строке:

```console
dapr run --app-id ordering-api --log-level info --log-as-json dotnet run
```

В Kubernetes можно добавить `dapr.io/log-as-json` заметку для каждого развертывания приложения:

```yaml
annotations:
   dapr.io/enabled: "true"
   dapr.io/app-id: "ordering-api"
   dapr.io/app-port: "80"
   dapr.io/config: "dapr-config"
   dapr.io/log-as-json: "true"
```

При установке ДАПР в кластере Kubernetes с помощью Helm можно включить ведение журнала в формате JSON для всех системных служб ДАПР:

```console
helm repo add dapr https://dapr.github.io/helm-charts/
helm repo update
kubectl create namespace dapr-system
helm install dapr dapr/dapr --namespace dapr-system --set global.logAsJson=true
```

#### <a name="collect-logs"></a>Сбор журналов

Журналы, созданные ДАПР, можно поставлять в серверную части мониторинга для анализа. Сборщик данных журнала — это компонент, собирающий журналы из системы и отправляющий их в серверную части мониторинга. Широко распространенный сборщик журналов [.](https://www.fluentd.org/) Ознакомьтесь с [инструкциями по настройке, эластичным поиском и Kibana в Kubernetes](https://docs.dapr.io/operations/monitoring/fluentd/) в документации по ДАПР. Эта статья содержит инструкции по настройке в качестве сборщика журналов и [стека Elk](https://www.elastic.co/elastic-stack) (эластичный Поиск и Kibana) в качестве серверной части мониторинга.

### <a name="health-status"></a>Состояние работоспособности

Состояние работоспособности службы позволяет понять ее доступность. Каждый ДАПР расширения предоставляет API работоспособности, который может использоваться средой размещения для определения работоспособности расширения. API имеет одну операцию:

```console
GET http://localhost:3500/v1.0/healthz
```

Операция возвращает два кода состояния HTTP:

- 204: Если расширения работоспособен
- 500: Если расширения не исправен

При работе в автономном режиме API работоспособности не вызывается автоматически. Вы можете вызвать API, используя код приложения или средство мониторинга работоспособности.

При выполнении в Kubernetes ДАПР расширения-инжектор автоматически настраивает Kubernetes для использования API работоспособности *для выполнения проверок* *готовности и проб подготовки*.

Kubernetes использует проверки Live, чтобы определить, работает ли контейнер. Если зонд проверки на актуальность возвращает код ошибки, Kubernetes считает, что контейнер недоступен, и автоматически перезапускает его. Эта функция увеличивает общую доступность приложения.

Kubernetes использует проверки готовности, чтобы определить, готов ли контейнер к приему трафика. Модуль POD считается готовым, когда все его контейнеры готовы. Готовность определяет, может ли служба Kubernetes направлять трафик в модуль в сценарии балансировки нагрузки. Модули Pod, которые не готовы, автоматически удаляются из балансировщика нагрузки.

Проверки актуальности и готовности имеют несколько настраиваемых параметров. Оба параметра настраиваются в разделе спецификации контейнера файла манифеста Pod. По умолчанию ДАПР использует следующую конфигурацию для каждого контейнера расширения:

```yaml
livenessProbe:
      httpGet:
        path: v1.0/healthz
        port: 3500
      initialDelaySeconds: 5
      periodSeconds: 10
      timeoutSeconds : 5
      failureThreshold : 3
readinessProbe:
      httpGet:
        path: v1.0/healthz
        port: 3500
      initialDelaySeconds: 5
      periodSeconds: 10
      timeoutSeconds : 5
      failureThreshold: 3
```

 Для проб доступны следующие параметры:

- `path`Указывает конечную точку API работоспособности ДАПР.
- `port`Указывает порт API работоспособности ДАПР.
- `initialDelaySeconds`Указывает число секунд, в течение которых Kubernetes будет ожидать перед первым запуском проверки контейнера.
- `periodSeconds`Указывает количество секунд, в течение которых Kubernetes будет ожидать каждой проверки.
- `timeoutSeconds`Указывает число секунд, в течение которых Kubernetes будет ожидать ответа от API до истечения времени ожидания. Время ожидания интерпретируется как сбой.
- `failureThreshold`Указывает число неудачно завершенного кода состояния Kubernetes, которое будет принято до рассмотрения того, что контейнер не является активным или не готов.

### <a name="dapr-dashboard"></a>Панель мониторинга ДАПР

ДАПР предлагает панель мониторинга, в которой представлены сведения о состоянии приложений, компонентов и конфигураций ДАПР. Используйте интерфейс командной строки ДАПР, чтобы запустить панель мониторинга как веб-приложение на локальном компьютере через порт 8080:

```console
dapr dashboard
```

Для приложения ДАПР, работающего в Kubernetes, используйте следующую команду:

```console
dapr dashboard -k
```

Откроется панель мониторинга с обзором всех служб в приложении с ДАПР расширения. На следующем снимке экрана показана панель мониторинга ДАПР для приложения Ешопондапр, работающего в Kubernetes:

![Страница обзора панели мониторинга ДАПР](media/observability/dapr-dashboard-overview.png)

Панель мониторинга ДАПР не имеет ценности при устранении неполадок в приложении ДАПР. В нем содержатся сведения о ДАПР сидекарс и системных службах. Можно детализировать конфигурацию каждой службы, включая записи журнала.

На панели мониторинга также отображаются настроенные компоненты (и их конфигурация) для приложения:

![Страница компонентов панели мониторинга ДАПР](media/observability/dapr-dashboard-components.png)

На панели мониторинга доступен большой объем информации. Его можно обнаружить, запустив приложение ДАПР и просмотрев панель мониторинга. Для запуска можно использовать сопутствующее приложение Ешопондапр.

Дополнительные сведения о командах панели мониторинга ДАПР см. в [справочнике по командам CLI панели мониторинга ДАПР в документации](https://docs.dapr.io/reference/cli/dapr-dashboard/) по ДАПР.

## <a name="use-the-dapr-net-sdk"></a>Использование пакета SDK для ДАПР .NET

Пакет SDK для ДАПР .NET не содержит никаких специальных возможностей наблюдения. Все функции наблюдаемых элементов предлагаются на уровне ДАПР.

Если вы хотите создавать данные телеметрии из кода приложения .NET, следует рассмотреть [пакет SDK для опентелеметри для .NET](https://opentelemetry.io/docs/net/). Открытый проект телеметрии — это кросс-платформенный, Открытый исходный код и независимый от поставщика. Она предоставляет комплексную реализацию для создания, выдачи, сбора, обработки и экспорта данных телеметрии. Существует одна библиотека инструментирования для каждого языка, которая поддерживает автоматическое и ручное инструментирование. Данные телеметрии публикуются с использованием стандарта Open телеметрии. В проекте предусмотрена широкая поддержка отрасли и внедрение от поставщиков облачных услуг, поставщиков и конечных пользователей.

## <a name="reference-application-eshopondapr"></a>Эталонное приложение: Ешопондапр

Наблюдаемость в сопутствующем справочном приложении Ешопондапр состоит из нескольких частей. Перехватывается данные телеметрии из всех сидекарс. Кроме того, существуют другие функции наблюдения, унаследованные от предыдущего примера eShopOnContainers.

### <a name="custom-health-dashboard"></a>Настраиваемая панель мониторинга работоспособности

Проект **состояния** ешопондапр — это настраиваемая панель мониторинга работоспособности, которая позволяет получить представление о работоспособности служб ешоп. Эта панель мониторинга не использует API работоспособности ДАПР, но использует встроенный [механизм проверок работоспособности](/aspnet/core/host-and-deploy/health-checks) ASP.NET Core. Панель мониторинга не только предоставляет состояние работоспособности служб, но и работоспособность зависимостей служб. Например, служба, использующая базу данных, также предоставляет состояние работоспособности этой базы данных, как показано на следующем снимке экрана:

![Настраиваемая панель мониторинга работоспособности Ешопондапр](media/observability/eshop-health-dashboard.png)

### <a name="seq-log-aggregator"></a>Агрегатор журнала Seq

[Seq](https://datalust.co/seq) — это популярный сервер агрегатора журналов, который используется в ешопондапр для статистической обработки журналов. Seq принимает ведение журнала из служб приложений, но не из ДАПР системных служб или сидекарс. Seq индексирует ведение журнала приложений и предлагает веб-интерфейс для анализа и запроса журналов. Она также предлагает функции для создания панелей мониторинга.

Службы приложений Ешопондапр выдают структурированный журнал с помощью библиотеки ведения журнала [SeriLog](https://serilog.net/) . Serilog публикует события журнала в конструкции, называемой **приемником**. Приемник — это просто Целевая платформа, в которую Serilog записывает события ведения журнала. [Доступно множество приемников Serilog](https://github.com/serilog/serilog/wiki/Provided-Sinks), в том числе один для Seq. Seq — это приемник Serilog, используемый в Ешопондапр.

### <a name="application-insights"></a>Application Insights

Ешопондапр Services также отправляют данные телеметрии непосредственно в Azure Application Insights с помощью пакета SDK для Microsoft Application Insights для .NET Core. Дополнительные сведения см. в статье [Application Insights Azure для ASP.NET Core приложений](/azure/azure-monitor/app/asp-net-core) в документации Майкрософт.

## <a name="summary"></a>Итоги

Хорошее наблюдаемое значение очень важно при запуске распределенной системы в рабочей среде.

ДАПР предоставляет различные типы телеметрии, включая распределенную трассировку, ведение журнала, метрики и состояние работоспособности.

ДАПР создает данные телеметрии только для системных служб ДАПР и сидекарс. Данные телеметрии из кода приложения не включаются автоматически. Однако вы можете использовать конкретный пакет SDK, например пакет SDK для Опентелеметри для .NET, чтобы создавать данные телеметрии из кода приложения.

Данные телеметрии ДАПР создаются в формате с открытым стандартом, поэтому его можно принять с помощью большого набора доступных средств мониторинга. Примеры: Зипкин, Azure Application Insights, ELK Stack, New Relic и Grafana. Руководства по мониторингу приложений ДАПР с конкретными серверными элементами мониторинга см. в статье [мониторинг приложения с помощью ДАПР](https://docs.dapr.io/operations/monitoring/) в документации ДАПР.

Вам потребуются отходы телеметрии, которые принимают данные телеметрии и публикуют их в серверной части мониторинга.

ДАПР можно настроить для выдачи структурированного журнала. Структурированное ведение журнала предпочтительнее, так как оно может индексироваться средствами серверного мониторинга. Индексированное ведение журнала позволяет пользователям выполнять расширенные запросы при поиске в журнале.

ДАПР предлагает панель мониторинга, в которой представлены сведения о службах и конфигурации ДАПР.

## <a name="references"></a>Ссылки

- [Azure Application Insights](/azure/azure-monitor/app/app-insights-overview/)
- [Открыть телеметрию](https://opentelemetry.io/)
- [зипкин](https://zipkin.io/)
- [Контекст трассировки W3C](https://www.w3.org/TR/trace-context/)
- [Jaeger](https://www.jaegertracing.io/)
- [New Relic](https://newrelic.com/)
- [Prometheus](https://prometheus.io/)
- [Grafana](https://grafana.com/grafana/)
- [Открытие пакета SDK для телеметрии для .NET](https://opentelemetry.io/docs/net/)
- [Fluentd](https://www.fluentd.org/)
- [Стек ELK](https://www.elastic.co/elastic-stack)
- [Порядк](https://datalust.co/seq)
- [Serilog](https://serilog.net/)

> [!div class="step-by-step"]
> [Назад](bindings.md)
> [Вперед](secrets.md)
