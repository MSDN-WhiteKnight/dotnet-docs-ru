---
title: Сценарии развертывания при переходе на ASP.NET Core
description: Обзор различных подходов к развертыванию, которые можно использовать при переносе из ASP.NET в ASP.NET Core, что обеспечивает параллельную и поэтапную миграцию.
author: ardalis
ms.date: 11/13/2020
ms.openlocfilehash: 589acd8c66baacc3aef5833dfaa24e2dcc5c1ee5
ms.sourcegitcommit: 42d436ebc2a7ee02fc1848c7742bc7d80e13fc2f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/04/2021
ms.locfileid: "102401774"
---
# <a name="deployment-scenarios-when-migrating-to-aspnet-core"></a>Сценарии развертывания при переходе на ASP.NET Core

[!INCLUDE [book-preview](../../../includes/book-preview.md)]

Существующие приложения ASP.NET MVC и веб-API работают в IIS и Windows. Большие приложения могут потребовать поэтапного или параллельного подхода при переносе в ASP.NET Core. В предыдущих главах вы узнали о нескольких стратегиях переноса больших платформа .NET Framework приложений на ASP.NET Core поэтапно. В этой главе вы узнаете, как можно добиться различных сценариев развертывания, когда в рабочей среде нужно сохранить исходное приложение, а не перенести его части.

## <a name="split-a-large-web-app"></a>Разделение большого веб-приложения

Рассмотрим типичный сценарий для большого веб-приложения, которое в настоящее время размещается в IIS на одном веб-сайте. В большом приложении функции сегментированы на разные маршруты и (или) каталоги. Приложение является смесью представлений MVC и конечных точек API. Маршруты MVC включают множество различных путей, основанных на функциональности, и все они начинаются с корневого каталога приложения, использующего стандартный `/{controller}/{action}/{id?}` шаблон маршрута. Конечные точки API соответствуют аналогичному шаблону, но находятся в `/api` корне.

При условии, что задача переноса приложения разбивается таким образом, что функциональность MVC или API переносится на ASP.NET Core сначала, как бы исходный сайт продолжал работать без проблем с новым приложением ASP.NET Core, которое работает где-то еще? Пользователи системы должны видеть те же URL-адреса, которые они делали перед миграцией, если это совершенно не требуется для их изменения.

К счастью, IIS — это очень мощный веб-сервер, и два компонента, которые он имел в течение некоторого времени, — это [модуль переопределения URL-адресов и Маршрутизация запросов приложений](/iis/extensions/url-rewrite-module/reverse-proxy-with-url-rewrite-v2-and-application-request-routing). Используя эти функции, службы IIS могут работать в качестве [обратного прокси-сервера](/iis/extensions/url-rewrite-module/reverse-proxy-with-url-rewrite-v2-and-application-request-routing)и перенаправлять запросы клиентов в соответствующее серверное веб-приложение. Чтобы настроить службы IIS в качестве обратных прокси-серверов, установите флажок **Enable proxy (включить прокси** ) в функции маршрутизации запросов приложений, а затем добавьте правило переопределения URL-адресов, как показано ниже.

```xml
<rule name="NetCoreProxy">
  <match url="(.*)> />
  <action type="Rewrite" url="http://servername/{R:1}" />
</rule>
```

В качестве обратных прокси-серверов службы IIS могут направлять трафик, соответствующий определенным шаблонам, в совершенно отдельные приложения, которые могут быть на разных серверах.

Используя только модуль переопределения URL-адресов (возможно, в сочетании с заголовками узлов), службы IIS могут легко поддерживать несколько веб-сайтов, каждая из которых может работать под управлением разных версий .NET. Большое веб-приложение может быть развернуто в виде коллекции отдельных сайтов, каждый из которых отвечает на разные IP-адреса и (или) заголовки узлов, или как один веб-сайт с одним или несколькими вложенными приложениями, отвечающими на определенные пути URL-адресов (что даже не требует перезаписи URL-адреса).

> [!IMPORTANT]
> Поддомены обычно ссылаются на часть домена, предшествующую двум верхним уровням. Например, в домене `api.contoso.com` `api` — это `contoso.com` поддомен домена (который состоит из доменного `contoso` имени и `.com` верхнего уровня домена или TLD). URL-пути относятся к части URL-адреса, следующей за именем домена, начиная с `/` . URL-адрес `https://contoso.com/api` имеет путь `/api` .

Существуют преимущества и недостатки использования одних и тех же или разных поддоменов (и доменов) для размещения одного приложения. Такие функции, как файлы cookie и взаимодействие внутри приложения с помощью таких механизмов, как [CORS](/aspnet/core/security/cors) , могут потребовать дополнительной настройки для правильной работы в распределенных приложениях. Однако приложения, использующие разные поддомены, могут более просто использовать DNS для маршрутизации запросов к совершенно разным назначениям сети, поэтому их можно легко развернуть на многих серверах (виртуальном или ином) без необходимости использования IIS в качестве обратного прокси-сервера.

В приведенном выше примере предположим, что конечные точки API обозначены как первая часть приложения для переноса в ASP.NET Core. В этом случае новое приложение ASP.NET Core создается и размещается в IIS как отдельное веб- *приложение* на веб- *сайте* MVC ASP.NET. Так как он будет добавлен как дочерний элемент исходного веб-сайта и будет называться *API*, его маршрут по умолчанию больше не должен начинаться с `api/` . Это приведет к тому, что он будет сопоставлять URL-адреса формы `/api/api/endpoint` .

На рис. 5-1 показано, как приложение *api* ASP.NET Core 2,1 отображается в диспетчере служб IIS как часть существующего сайта *дотнетмвкапп* .

![Диспетчер IIS, отображающий приложение API на платформа .NET Framework сайте](./media/Figure5-1.png)

**Рис. 5-1**. Платформа .NET Framework сайт с приложением .NET Core в IIS.

Сайт *дотнетмвкапп* размещается как приложение MVC 5, работающее на платформа .NET Framework 4.7.2. Он имеет собственный пул приложений IIS, настроенный в интегрированном режиме и выполняющий .NET CLR версии 4.0.30319. Приложение *API* — это ASP.NET Core приложение, работающее на платформа .NET Framework 4.6.1 ( `net461` ). Он был добавлен в *дотнетмвкапп* как новое приложение IIS и настроен для использования собственного пула приложений. Его пул приложений также работает в интегрированном режиме, но для него настроена версия CLR .NET **без управляемого кода** , так как он будет выполнен с помощью [модуля ASP.NET Core](/aspnet/core/host-and-deploy/aspnet-core-module?preserve-view=true&view=aspnetcore-2.1). В качестве примера используется только версия ASP.NET Core приложения. Его также можно настроить для работы в .NET Core 3,1 или .NET 5,0. Но на этом этапе больше не будет возможности ориентироваться на платформа .NET Framework библиотеки (см. раздел [Выбор правильной версии .NET Core](choose-net-core-version.md)).

Таким образом, единственное изменение, которое необходимо сделать для того, чтобы интерфейсы API ASP.NET Coreного приложения правильно направлялись, — изменить его шаблон маршрута по умолчанию с `[Route("[api/controller]")]` на `[Route("[controller]")]` .

Кроме того, ASP.NET Core приложение может быть другим веб-сайтом верхнего уровня в IIS. В этом случае можно настроить исходный сайт для использования правила перезаписи (с [перезаписью URL-адреса](https://www.iis.net/downloads/microsoft/url-rewrite)), которое будет перенаправляться в другое приложение, если путь начинается с `/api` . Приложение ASP.NET Core может использовать другой заголовок узла для своего маршрута, чтобы он не конфликтовали с основным приложением, но мог отвечать на запросы с помощью корневых маршрутов.

Например, одно и то же приложение ASP.NET Core, используемое на рис. 5-1, можно развернуть в другой папке, настроенной как веб-сайт IIS. Сайт должен использовать пул приложений, настроенный так же, как и ранее, без **управляемого кода**. Настройте привязку для реагирования на уникальное имя узла на сервере, например `api.contoso.com` . Чтобы настроить перезапись URL-адресов для запросов на перезапись, соответствующих `/api` просто добавьте новое правило для входящего трафика на уровне сервера IIS (или отдельного сайта). Сопоставьте шаблон `^/api(.*)` и укажите тип действия `Rewrite` и URL-адрес перезаписи для `api.contoso.com/{R:1}` . Сочетание использования `(.*)` в шаблоне сопоставления и `{R:1}` в URL-адресе перезаписи обеспечит, что остальная часть пути будет использоваться с новым URL-адресом. При этом отдельные сайты на одном и том же сервере IIS могут совместно работать под управлением отдельных версий .NET, но они могут отображаться в Интернете как одно веб-приложение. На рис. 5-2 показано правило перезаписи, настроенное в IIS с помощью отдельного веб-сайта.

![Диспетчер IIS, демонстрирующий правило переопределения URL-адресов для маршрутизации запросов вложенных папок на отдельный веб-сайт](./media/Figure5-2.png)

**Рис. 5-2**. Правило перезаписи для перезаписи запросов к вложенным папкам на другой веб-сайт.

Если приложению требуется единый вход между разными сайтами или приложениями в IIS, см. документацию о том, [как совместно использовать файлы cookie проверки подлинности в приложениях ASP.NET](/aspnet/core/host-and-deploy/iis/) для получения подробных инструкций по поддержке этого сценария.

## <a name="summary"></a>Итоги

Распространенный подход к переносу больших приложений с платформа .NET Framework на ASP.NET Core — выбор отдельных частей приложения для их переноса по одному. По мере переноса каждого фрагмента приложения все приложение остается работающим и пригодным для использования, при этом некоторые компоненты запускаются в исходной конфигурации и других компонентах, работающих в некоторой версии .NET Core. При использовании этого подхода можно выполнить добавочную миграцию большого приложения. Такой подход приводит к ограничению риска за счет более быстрого отзыва и сокращения общей контактной зоны, участвующей в тестировании. Это также позволяет более быстро прирабатывать преимущества .NET Core, такие как увеличение производительности. Несмотря на то, что ASP.NET Core приложения больше не нужны для размещения в службах IIS, IIS остается очень гибким и мощным веб-сервером, который можно настроить для поддержки различных сценариев размещения, включающих как платформа .NET Framework, так и ASP.NET Core приложения на одном экземпляре IIS или даже размещается на разных серверах.

## <a name="references"></a>Ссылки

- [Размещение ASP.NET Core в Windows со службами IIS](/aspnet/core/host-and-deploy/iis/)
- [Модуль переопределения URL-адресов и Маршрутизация запросов приложений](/iis/extensions/url-rewrite-module/reverse-proxy-with-url-rewrite-v2-and-application-request-routing)
- [Переопределение URL-адресов](https://www.iis.net/downloads/microsoft/url-rewrite)
- [Модуль ASP.NET Core](/aspnet/core/host-and-deploy/aspnet-core-module?preserve-view=true&view=aspnetcore-2.1)
- [Совместное использование файлов cookie проверки подлинности между приложениями ASP.NET](/aspnet/core/host-and-deploy/iis/)
- [Примеры, используемые в этом разделе](https://github.com/ardalis/MigrateDotNetWithIIS)

>[!div class="step-by-step"]
>[Назад](more-migration-scenarios.md)
>[Вперед](summary.md)
