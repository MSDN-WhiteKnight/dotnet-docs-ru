---
description: 'Дополнительные сведения: сохранение и восстановление часовых поясов'
title: Сохранение и восстановление часовых поясов
ms.date: 04/10/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- restoring time zones
- deserialization [.NET], time zones
- serialization [.NET], time zones
- time zone objects [.NET], restoring
- saving time zones
- time zone objects [.NET], deserializing
- time zones [.NET], saving
- time zones [.NET], restoring
- time zone objects [.NET], serializing
- time zone objects [.NET], saving
ms.assetid: 4028b310-e7ce-49d4-a646-1e83bfaf6f9d
ms.openlocfilehash: bd888c2d9a1f02fa05fd1abf9d984022be03e192
ms.sourcegitcommit: ddf7edb67715a5b9a45e3dd44536dabc153c1de0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/06/2021
ms.locfileid: "99702448"
---
# <a name="saving-and-restoring-time-zones"></a>Сохранение и восстановление часовых поясов

<xref:System.TimeZoneInfo>Класс использует реестр для получения предопределенных данных часового пояса. Однако реестр является динамической структурой. Кроме того, сведения о часовом поясе, которые содержит реестр, используются операционной системой в основном для управления настройкой времени и преобразованиями в текущем году. Это имеет два существенных последствия для приложений, которые зависят от точных данных часового пояса:

- Часовой пояс, необходимый для приложения, может не быть определен в реестре, или он мог быть переименован или удален из реестра.

- Часовой пояс, определенный в реестре, может не иметь сведений о конкретных правилах коррекции, необходимых для преобразования исторических часовых поясов.

<xref:System.TimeZoneInfo>Класс обращается к этим ограничениям с помощью поддержки сериализации (сохранения) и десериализации (восстановления) данных часового пояса.

## <a name="time-zone-serialization-and-deserialization"></a>Сериализация и десериализация часовых поясов

Сохранение и восстановление часового пояса путем сериализации и десериализации данных часового пояса состоит только из двух вызовов методов:

- Можно сериализовать <xref:System.TimeZoneInfo> объект, вызвав метод этого объекта <xref:System.TimeZoneInfo.ToSerializedString%2A> . Метод не принимает параметров и возвращает строку, содержащую сведения о часовом поясе.

- Можно десериализовать <xref:System.TimeZoneInfo> объект из сериализованной строки, передав эту строку `static` `Shared` методу (в Visual Basic) <xref:System.TimeZoneInfo.FromSerializedString%2A?displayProperty=nameWithType> .

## <a name="serialization-and-deserialization-scenarios"></a>Сценарии сериализации и десериализации

Возможность сохранения (или сериализации) <xref:System.TimeZoneInfo> объекта в строку и восстановления (или десериализации) для последующего использования увеличивает и программу, и гибкость <xref:System.TimeZoneInfo> класса. В этом разделе рассматриваются некоторые ситуации, в которых сериализация и десериализация наиболее полезны.

### <a name="serializing-and-deserializing-time-zone-data-in-an-application"></a>Сериализация и десериализация данных часового пояса в приложении

Сериализованный часовой пояс можно восстановить из строки при необходимости. Приложение может сделать это, если часовой пояс, полученный из реестра, не может правильно преобразовать дату и время в определенном диапазоне дат. Например, данные часового пояса в реестре Windows XP поддерживают одно правило коррекции, а Часовые пояса, определенные в реестре Windows Vista, обычно предоставляют сведения о двух правилах коррекции. Это означает, что преобразования исторического времени могут быть неточными. Это ограничение может быть обработано сериализацией и десериализацией данных часового пояса.

В следующем примере определен пользовательский класс <xref:System.TimeZoneInfo> без правил корректировки, представляющий время в восточном стандартном часовом поясе США в период с 1883 по 1917 годы до введения перехода на летнее время в США. Пользовательский часовой пояс сериализуется в переменную с глобальной областью действия. Методу преобразования часового пояса `ConvertUtcTime` передается время в формате UTC для преобразования. Если дата и время происходят в 1917 или более ранней версии, настраиваемый Стандартный часовой пояс восстанавливается из сериализованной строки и заменяет часовой пояс, полученный из реестра.

[!code-csharp[System.TimeZone2.Serialization.1#1](../../../samples/snippets/csharp/VS_Snippets_CLR_System/system.TimeZone2.Serialization.1/cs/Serialization.cs#1)]
[!code-vb[System.TimeZone2.Serialization.1#1](../../../samples/snippets/visualbasic/VS_Snippets_CLR_System/system.TimeZone2.Serialization.1/vb/Serialization.vb#1)]

### <a name="handling-time-zone-exceptions"></a>Обработка исключений часовых поясов

Поскольку реестр является динамической структурой, его содержимое подвержено случайному или намеренному изменению. Это означает, что часовой пояс, который должен быть определен в реестре и который необходим для успешного выполнения приложения, может отсутствовать. Без поддержки сериализации и десериализации часовых поясов у вас есть немало выбора, но для решения этой <xref:System.TimeZoneNotFoundException> программы необходимо завершить приложение. Однако с помощью сериализации и десериализации часовых поясов можно выполнить непредвиденную обработку, <xref:System.TimeZoneNotFoundException> восстановив требуемый часовой пояс из сериализованной строки, и приложение продолжит работу.

В следующем примере создается и сериализуется настраиваемый Центральный часовой пояс. Затем он пытается получить центральный стандартный часовой пояс из реестра. Если операция извлечения создает исключение <xref:System.TimeZoneNotFoundException> или <xref:System.InvalidTimeZoneException> , обработчик исключений десериализует часовой пояс.

[!code-csharp[System.TimeZone2.Serialization.2#1](../../../samples/snippets/csharp/VS_Snippets_CLR_System/system.TimeZone2.Serialization.2/cs/Serialization2.cs#1)]
[!code-vb[System.TimeZone2.Serialization.2#1](../../../samples/snippets/visualbasic/VS_Snippets_CLR_System/system.TimeZone2.Serialization.2/vb/Serialization2.vb#1)]

### <a name="storing-a-serialized-string-and-restoring-it-when-needed"></a>Сохранение сериализованной строки и ее восстановление при необходимости

В предыдущих примерах хранились сведения о часовом поясе в строковую переменную и восстановлена при необходимости. Однако строка, которая содержит сериализованные сведения о часовом поясе, сама по себе может храниться на некоторых носителях, например во внешнем файле, файле ресурсов, внедренном в приложение, или в реестре. (Обратите внимание, что сведения о пользовательских часовых поясах следует хранить отдельно от разделов системного часового пояса в реестре.)

Хранение сериализованной строки часового пояса таким образом также отделяет подпрограммы создания часового пояса от самого приложения. Например, можно выполнить процедуру создания часового пояса и создать файл данных, содержащий исторические сведения о часовом поясе, которые может использовать приложение. Файл данных можно затем установить вместе с приложением. его можно открыть, а также при необходимости десериализовать один или несколько часовых поясов, если они требуются приложению.

Пример использования внедренного ресурса для хранения сериализованных данных часового пояса см. в разделе [как сохранить часовой пояс во внедренном ресурсе](save-time-zones-to-an-embedded-resource.md) и [как восстановить Часовые пояса из внедренного ресурса](restore-time-zones-from-an-embedded-resource.md).

## <a name="see-also"></a>См. также

- [Даты, время и часовые пояса](index.md)
