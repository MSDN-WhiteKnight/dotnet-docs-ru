---
title: Анализ кода в .NET
titleSuffix: ''
description: Сведения об анализе исходного кода в пакете SDK для .NET.
ms.date: 12/04/2020
ms.topic: overview
ms.custom: updateeachrelease
helpviewer_keywords:
- code analysis
- code analyzers
ms.openlocfilehash: eb978d6af6695fd2e4b5473ac5c0dc216e726e52
ms.sourcegitcommit: 10e719780594efc781b15295e499c66f316068b8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/14/2021
ms.locfileid: "100459959"
---
# <a name="overview-of-net-source-code-analysis"></a>Обзор анализа исходного кода .NET

Анализаторы компилятора .NET Platform (Roslyn) Analyzer проверяют код C# или Visual Basic для проблем качества кода и стиля. Начиная с .NET 5,0 эти анализаторы входят в состав пакета SDK для .NET, и вам не нужно устанавливать их отдельно. Если проект предназначен для .NET 5 или более поздней версии, анализ кода включен по умолчанию. Если проект предназначен для другой реализации .NET, например .NET Core, .NET Standard или платформа .NET Framework, необходимо вручную включить анализ кода, задав для свойства [енабленетанализерс](../../core/project-sdk/msbuild-props.md#enablenetanalyzers) значение `true` .

Если вы не хотите переходить на пакет SDK для .NET 5 +, иметь платформа .NET Framework проект без пакета SDK или предпочитаете модель на основе пакета NuGet, анализаторы также доступны в [пакете NuGet Microsoft. CodeAnalysis. нетанализерс](https://www.nuget.org/packages/Microsoft.CodeAnalysis.NetAnalyzers). Вы можете предпочесть модели на основе пакетов для обновления версий по требованию.

> [!NOTE]
> Анализаторы .NET являются независимыми от целевой платформы. То есть проект не обязан ориентироваться на конкретную реализацию .NET. Анализаторы работают для проектов, предназначенных для, а также для `net5.0` более ранних версий .NET, таких как `netcoreapp3.1` и `net472` . Однако, чтобы включить анализ кода с помощью свойства [енабленетанализерс](../../core/project-sdk/msbuild-props.md#enablenetanalyzers) , ваш проект должен ссылаться на [пакет SDK проекта](../../core/project-sdk/overview.md).

Если анализатор обнаруживает нарушения правил, они включаются в отчет как предложение, предупреждение или ошибку в зависимости от того, как [настроено](configuration-options.md)каждое правило. Нарушения анализа кода отображаются с префиксом "CA" или "IDE", чтобы отличать их от ошибок компилятора.

## <a name="code-quality-analysis"></a>Анализ качества кода

Правила *анализа качества кода* ("какскскскс") проверяют код C# или Visual Basic для обеспечения безопасности, производительности, проектирования и других проблем. По умолчанию для проектов, предназначенных для .NET 5,0 или более поздней версии, включен анализ. Вы можете включить анализ кода для проектов, предназначенных для более ранних версий .NET, задав для свойства [енабленетанализерс](../../core/project-sdk/msbuild-props.md#enablenetanalyzers) значение `true` . Можно также отключить анализ кода для проекта, задав для значение `EnableNETAnalyzers` `false` .

> [!TIP]
> Если вы используете Visual Studio:
>
> - Многие правила анализатора связаны с *исправлениями кода* , которые можно применить для устранения проблемы. Исправления кода отображаются в меню значка лампочки.
> - Можно включить или отключить анализ кода, щелкнув правой кнопкой мыши проект в Обозреватель решений и выбрав **Свойства**  >  вкладка **анализ кода** > **включить анализаторы .NET**.

### <a name="enabled-rules"></a>Включенные правила

По умолчанию в .NET 5,0 включены следующие правила.

| ИД диагностики | Категория | Статус | Описание |
| - | - | - | - |
| [CA1416](/visualstudio/code-quality/ca1416) | Совместимость | Предупреждение | Анализатор совместимости платформ |
| [CA1417](/visualstudio/code-quality/ca1417) | Совместимость | Предупреждение | Не используйте `OutAttribute` в строковых параметрах для P/Invoke |
| [CA1831](/visualstudio/code-quality/ca1831) | Производительность | Предупреждение | Используйте `AsSpan` вместо индексаторов на основе диапазона для строки, если это уместно |
| [CA2013](/visualstudio/code-quality/ca2013) | Надежность | Предупреждение | Не используйте `ReferenceEquals` с типами значений |
| [CA2014](/visualstudio/code-quality/ca2014) | Надежность | Предупреждение | Не используйте `stackalloc` в циклах |
| [CA2015](/visualstudio/code-quality/ca2015) | Надежность | Предупреждение | Не определяйте методы завершения для типов, производных от <xref:System.Buffers.MemoryManager%601> |
| [CA2200](/visualstudio/code-quality/ca2200) | Использование | Предупреждение | Повторно порождайте исключения для сохранения сведений стека
| [CA2247](/visualstudio/code-quality/ca2247) | Использование | Предупреждение | Аргумент, переданный в конструктор TaskCompletionSource, должен быть <xref:System.Threading.Tasks.TaskCreationOptions> перечислением, а не <xref:System.Threading.Tasks.TaskContinuationOptions> |

Можно изменить серьезность этих правил, чтобы отключить их или повысить их уровень до ошибок. Можно также [включить дополнительные правила](#enable-additional-rules).

- Список правил, которые входят в состав каждой версии пакета SDK для .NET, см. в разделе [выпуски анализатора](https://github.com/dotnet/roslyn-analyzers/blob/master/src/NetAnalyzers/Core/AnalyzerReleases.Shipped.md).
- Список всех правил качества кода см. в разделе [Правила качества кода](quality-rules/index.md).

### <a name="enable-additional-rules"></a>Включить дополнительные правила

*Режим анализа* означает предопределенную конфигурацию анализа кода, в которой включены все правила, некоторые или все. В режиме анализа по умолчанию только небольшое количество правил [включается в качестве предупреждений сборки](#enabled-rules). Можно изменить режим анализа для проекта, задав [\<AnalysisMode>](../../core/project-sdk/msbuild-props.md#analysismode) свойство в файле проекта. Допустимые значения:

| Значение | Описание |
| - | - |
| `AllDisabledByDefault` | Это наиболее консервативный режим. По умолчанию все правила отключены. Можно выборочно [принять](configuration-options.md) отдельные правила, чтобы включить их.<br /><br />`<AnalysisMode>AllDisabledByDefault</AnalysisMode>` |
| `AllEnabledByDefault` | Это самый агрессивный режим. Все правила включены как предупреждения сборки. Можно выборочно [отказаться от](configuration-options.md) отдельных правил, чтобы отключить их.<br /><br />`<AnalysisMode>AllEnabledByDefault</AnalysisMode>` |
| `Default` | Режим по умолчанию, где несколько правил включены как предупреждения, другие включаются только в качестве предложений интегрированной среды разработки Visual Studio с соответствующими исправлениями кода, а остальные отключаются полностью. Вы можете выборочно [принять или отказаться от](configuration-options.md) отдельных правил, чтобы отключить их.<br /><br />`<AnalysisMode>Default</AnalysisMode>` |

Чтобы найти уровень серьезности по умолчанию для каждого доступного правила и определить, включено ли правило в режиме анализа по умолчанию, см. [полный список правил](https://github.com/dotnet/roslyn-analyzers/blob/master/src/NetAnalyzers/Core/AnalyzerReleases.Shipped.md).

### <a name="treat-warnings-as-errors"></a>Рассматривать предупреждения как ошибки

При использовании `-warnaserror` флага при построении проектов все предупреждения анализа кода также обрабатываются как ошибки. Если вы не хотите, чтобы предупреждения качества кода обрабатывались как ошибки в присутствии `-warnaserror` , можно задать `CodeAnalysisTreatWarningsAsErrors` для свойства MSBuild значение `false` в файле проекта.

```xml
<PropertyGroup>
  <CodeAnalysisTreatWarningsAsErrors>false</CodeAnalysisTreatWarningsAsErrors>
</PropertyGroup>
```

Вы по-прежнему увидите предупреждения анализа кода, но они не нарушат сборку.

### <a name="latest-updates"></a>Последние обновления

По умолчанию при обновлении до более новых версий пакета SDK для .NET вы получите последние правила анализа кода и серьезность правил по умолчанию. Если вы не хотите этого делать, например, если вы хотите убедиться, что новые правила не включены или отключены, их можно переопределить одним из следующих способов.

- Задайте `AnalysisLevel` для свойства MSBuild определенное значение, чтобы заблокировать предупреждения для этого набора. При обновлении до более нового пакета SDK вы по-прежнему получаете исправления ошибок для этих предупреждений, но новые предупреждения не будут включены, а существующие предупреждения не будут отключены. Например, чтобы заблокировать набор правил для тех, которые поставляются с пакетом SDK для .NET версии 5,0, добавьте следующую запись в файл проекта.

  ```xml
  <PropertyGroup>
    <AnalysisLevel>5.0</AnalysisLevel>
  </PropertyGroup>
  ```

  > [!TIP]
  > Значение свойства по умолчанию `AnalysisLevel` — `latest` , что означает, что вы всегда получаете последние правила анализа кода при переходе на более новые версии пакета SDK для .NET.

  Дополнительные сведения и список возможных значений см. в разделе [аналисислевел](../../core/project-sdk/msbuild-props.md#analysislevel).

- Установите [пакет NuGet Microsoft. CodeAnalysis. нетанализерс](https://github.com/dotnet/roslyn-analyzers#microsoftcodeanalysisnetanalyzers) для отделения обновлений правил от обновлений пакета SDK для .NET. При установке пакета отключаются встроенные анализаторы SDK и создается предупреждение о сборке, если пакет SDK содержит более новую версию сборки анализатора, чем версия пакета NuGet.

## <a name="code-style-analysis"></a>Анализ в стиле кода

Правила *анализа в стиле кода* ("идекскскскс") позволяют определять и поддерживать единообразный стиль кода в базе кода. Параметры включения по умолчанию:

- Сборка из командной строки. по умолчанию для всех проектов .NET в сборках из командной строки отключен анализ в стиле кода.

  Начиная с .NET 5,0, можно [Включить анализ в стиле кода для сборки](#enable-on-build)как в командной строке, так и в Visual Studio. Нарушения стиля кода отображаются как предупреждения или ошибки с префиксом "IDE". Это позволяет применять единообразные стили кода во время сборки.

- Visual Studio: анализ в стиле кода включен по умолчанию для всех проектов .NET в Visual Studio в виде [быстрых действий по оптимизации кода](/visualstudio/ide/code-generation-in-visual-studio).

Полный список правил анализа в стиле кода см. в разделе [правила стиля кода](style-rules/index.md).

### <a name="enable-on-build"></a>Включить при сборке

С помощью пакета SDK для .NET 5,0 и более поздних версий можно включить анализ в стиле кода при построении из командной строки и в Visual Studio. (Однако по соображениям производительности некоторые [правила стиля кода](https://github.com/dotnet/roslyn/blob/9f87b444da9c48a4d492b19f8337339056bf2b95/src/Analyzers/Core/Analyzers/EnforceOnBuildValues.cs#L95) по-прежнему будут применяться только в интегрированной среде разработки Visual Studio.)

Чтобы включить анализ в стиле кода для сборки, выполните следующие действия.

1. Задайте для свойства MSBuild [енфорцекодестилеинбуилд](../../core/project-sdk/msbuild-props.md#enforcecodestyleinbuild) значение `true` .

1. В *editorconfig* -файле [Настройте](configuration-options.md) каждое правило стиля кода "IDE", которое вы хотите запускать при сборке как предупреждение или ошибку. Пример:

   ```ini
   [*.{cs,vb}]
   # IDE0040: Accessibility modifiers required (escalated to a build warning)
   dotnet_diagnostic.IDE0040.severity = warning
   ```

   Кроме того, можно настроить всю категорию как предупреждение или ошибку, по умолчанию, а затем выборочно отключить правила в этой категории, которые не нужно выполнять при сборке. Пример:

   ```ini
   [*.{cs,vb}]

   # Default severity for analyzer diagnostics with category 'Style' (escalated to build warnings)
   dotnet_analyzer_diagnostic.category-Style.severity = warning

   # IDE0040: Accessibility modifiers required (disabled on build)
   dotnet_diagnostic.IDE0040.severity = silent
   ```

> [!NOTE]
> Функция анализа в стиле кода экспериментальна и может изменяться в выпусках .NET 5 и .NET 6.

## <a name="suppress-a-warning"></a>Подавлять предупреждение

Одним из способов отключения нарушения правил является установка параметра серьезности для этого идентификатора правила `none` в файл EditorConfig. Пример:

```ini
dotnet_diagnostic.CA1822.severity = none
```

Дополнительные сведения и другие способы отключения предупреждений см. [в разделе Отключение предупреждений анализа кода](suppress-warnings.md).

## <a name="third-party-analyzers"></a>Сторонние анализаторы

Помимо официальных анализаторов .NET, можно также установить сторонние анализаторы, такие как [StyleCop](https://www.nuget.org/packages/StyleCop.Analyzers/), [Рослинатор](https://www.nuget.org/packages/Roslynator.Analyzers/), [xUnit Analyzers](https://www.nuget.org/packages/xunit.analyzers/)и [анализатор Sonar](https://www.nuget.org/packages/SonarAnalyzer.CSharp/).

## <a name="see-also"></a>См. также раздел

- [Справочник по правилам анализа качества кода](quality-rules/index.md)
- [Справочник по правилам анализа стиля кода](style-rules/index.md)
- [Анализ кода в Visual Studio](/visualstudio/code-quality/roslyn-analyzers-overview)
- [Пакет SDK для .NET Compiler Platform](../../csharp/roslyn-sdk/index.md)
- [Учебник. Создание средства для анализа и исправления кода](../../csharp/roslyn-sdk/tutorials/how-to-write-csharp-analyzer-code-fix.md)
