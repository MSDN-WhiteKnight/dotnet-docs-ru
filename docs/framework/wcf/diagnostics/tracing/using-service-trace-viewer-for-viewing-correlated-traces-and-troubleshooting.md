---
description: Дополнительные сведения см. в статье Использование средства Service Trace Viewer для просмотра связанных трассировок и устранения неполадок.
title: Использование программы Service Trace Viewer для просмотра скоррелированных трассировок и устранения неполадок
ms.date: 03/30/2017
ms.assetid: 05d2321c-8acb-49d7-a6cd-8ef2220c6775
ms.openlocfilehash: 3f6f48c3d366a024c5dcc0cdbc85c4aea47a7a8b
ms.sourcegitcommit: ddf7edb67715a5b9a45e3dd44536dabc153c1de0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/06/2021
ms.locfileid: "99758168"
---
# <a name="using-service-trace-viewer-for-viewing-correlated-traces-and-troubleshooting"></a>Использование программы Service Trace Viewer для просмотра скоррелированных трассировок и устранения неполадок

В этом разделе описываются формат данных трассировки, способ просмотра этих данных, а также подходы, в которых используется программа Service Trace Viewer для устранения неполадок приложения.

## <a name="using-the-service-trace-viewer-tool"></a>Использование программы Service Trace Viewer

Средство просмотра трассировки службы Windows Communication Foundation (WCF) помогает сопоставлять Диагностические трассировки, созданные прослушивателями WCF, для выявления причины ошибки. Это средство позволяет легко просматривать, группировать и фильтровать трассировки, чтобы можно было диагностировать, устранять и проверять проблемы со службами WCF. Дополнительные сведения об использовании этого средства см. в разделе [Service Trace Viewer Tool (SvcTraceViewer.exe)](../../service-trace-viewer-tool-svctraceviewer-exe.md).

В этом разделе содержатся снимки [экрана трассировки,](../../samples/tracing-and-message-logging.md) созданные при просмотре с помощью [средства Service Trace Viewer (SvcTraceViewer.exe)](../../service-trace-viewer-tool-svctraceviewer-exe.md). Показывается, как интерпретировать содержимое трассировки, действия и взаимосвязь между ними, а также как анализировать большое количество трассировок при устранении неполадок.

## <a name="viewing-trace-content"></a>Просмотр содержимого трассировки

Событие трассировки содержит следующие наиболее важные сведения:

- имя действия, если задано;

- время создания;

- уровень трассировки;

- Имя источника трассировки.

- имя процесса;

- идентификатор потока;

- Уникальный идентификатор трассировки — URL-адрес, указывающий на назначение в Документация Майкрософт, из которого можно получить дополнительные сведения, связанные с трассировкой.

 Все это можно увидеть в верхней правой панели средства просмотра трассировки служб или в разделе **Основные сведения** в форматированном представлении нижней правой панели при выборе трассировки.

> [!NOTE]
> Если клиент и служба установлены на одном и том же компьютере, то будут присутствовать трассировки для обоих приложений. Их можно фильтровать с помощью столбца **имя процесса** .

Кроме того, в форматированном представлении отображаются также описание трассировки и дополнительные подробные сведения, если они доступны. Дополнительные подробные сведения могут включать тип и сообщение исключения, стеки вызовов, действие сообщения, поля "от/к" и другую информацию об исключении.

В представлении XML имеются следующие важные теги xml:

- `<SubType>` (уровень трассировки);

- `<TimeCreated>`.

- `<Source>` (имя источника трассировки);

- `<Correlation>` (идентификатор действия, заданный при создании трассировки);

- `<Execution>` (процесс и идентификатор потока);

- `<Computer>`.

- `<ExtendedData>`, включая `<Action>`, `<MessageID>` и `<ActivityId>`, установленные в заголовке сообщения при отправке сообщения.

При анализе трассировки "Передано сообщение по каналу" отображаются следующие сведения.

```xml
<E2ETraceEvent xmlns="http://schemas.microsoft.com/2004/06/E2ETraceEvent">
   <System xmlns="http://schemas.microsoft.com/2004/06/windows/eventlog/system">
      <EventID>262163</EventID>
      <Type>3</Type>
      <SubType Name="Information">0</SubType>
      <Level>8</Level>
      <TimeCreated SystemTime="2006-08-04T18:45:30.8491051Z" />
      <Source Name="System.ServiceModel" />
       <Correlation ActivityID="{27c6331d-8998-43aa-a382-03239013a6bd}"/>
       <Execution ProcessName="client" ProcessID="1808" ThreadID="1" />
       <Channel />
       <Computer>TEST1</Computer>
   </System>
   <ApplicationData>
       <TraceData>
          <DataItem>
             <TraceRecord xmlns="http://schemas.microsoft.com/2004/10/E2ETraceEvent/TraceRecord" Severity="Information">
                 <TraceIdentifier>http://msdn.microsoft.com/library/System.ServiceModel.Channels.MessageSent.aspx</TraceIdentifier>
                 <Description>Sent a message over a channel.</Description>
                 <AppDomain>client.exe</AppDomain>
                 <Source>System.ServiceModel.Channels.ClientFramingDuplexSessionChannel/35191196</Source>
                <ExtendedData xmlns="http://schemas.microsoft.com/2006/08/ServiceModel/MessageTransmitTraceRecord">

                  <MessageProperties>
                     <AllowOutputBatching>False</AllowOutputBatching>
                  </MessageProperties>
                  <MessageHeaders>
                     <Action d4p1:mustUnderstand="1" xmlns:d4p1="http://www.w3.org/2003/05/soap-envelope" xmlns="http://www.w3.org/2005/08/addressing">http://Microsoft.ServiceModel.Samples/ICalculator/Multiply</Action>
                     <MessageID xmlns="http://www.w3.org/2005/08/addressing">urn:uuid:7c6670d8-4c9c-496e-b6a0-2ceb6db35338</MessageID>
                     <ActivityId CorrelationId="b02e2189-0816-4387-980c-dd8e306440f5" xmlns="http://schemas.microsoft.com/2004/09/ServiceModel/Diagnostics">27c6331d-8998-43aa-a382-03239013a6bd</ActivityId>
                     <ReplyTo xmlns="http://www.w3.org/2005/08/addressing">
                        <Address>http://www.w3.org/2005/08/addressing/anonymous</Address>
                    </ReplyTo>
                    <To d4p1:mustUnderstand="1" xmlns:d4p1="http://www.w3.org/2003/05/soap-envelope" xmlns="http://www.w3.org/2005/08/addressing">net.tcp://localhost/servicemodelsamples/service</To>
                  </MessageHeaders>
                  <RemoteAddress>net.tcp://localhost/servicemodelsamples/service</RemoteAddress>
                </ExtendedData>
            </TraceRecord>
          </DataItem>
       </TraceData>
   </ApplicationData>
</E2ETraceEvent>
```

## <a name="servicemodel-e2e-tracing"></a>Трассировка ServiceModel E2E

Если `System.ServiceModel` источник трассировки задан с параметром, отличным `switchValue` от OFF, `ActivityTracing` WCF создает действия и передает данные для обработки WCF.

Действие - это логический блок обработки, объединяющий все связанные с ним трассировки. Например, для каждого запроса можно определить одно действие. Перенаправления создают причинно-следственную связь между действиями внутри конечных точек. Распространение идентификатора действия позволяет соотносить действия в разных конечных точках. Это можно сделать, задав `propagateActivity` = `true` в конфигурации в каждой конечной точке. Действия, перенаправления и распространение позволяют выполнить корреляцию ошибок. Это ускоряет выявление первопричины ошибки.

На клиенте для каждого вызова объектной модели создается одно действие WCF (например, открытие ChannelFactory, добавление, разделение и т. д.). Каждый вызов операции обрабатывается в действии "действие процесса".

На следующем снимке экрана, извлеченном из примера " [Трассировка и регистрация сообщений](../../samples/tracing-and-message-logging.md) ", на левой панели отображается список действий, созданных в процессе клиента, отсортированных по времени создания. Ниже приведен хронологический список действий.

- Создана фабрика каналов (ClientBase).

- Открыта фабрика каналов.

- Обработано действие Add.

- Установлен безопасный сеанс (это ПРОИЗОШЛО по первому запросу) и обработаны три ответных сообщения инфраструктуры безопасности: RST, RSTR, SCT (Process message 1, 2, 3).

- Обработаны запросы "Вычесть", "Умножить" и "Разделить".

- Закрыта фабрика каналов, в результате чего закрыт безопасный сеанс и обработана отмена ответа на сообщение безопасности.

 Сообщения инфраструктуры безопасности видны из-за привязки wsHttpBinding.

> [!NOTE]
> В WCF мы видим сообщения об ответах, которые изначально обрабатывались в отдельном действии (обработать сообщение), прежде чем сопоставлять их с соответствующим действием действия процесса, которое включает сообщение запроса посредством перемещения. Это происходит для сообщений инфраструктуры и асинхронных запросов из-за необходимости проверки сообщения, чтения заголовка с идентификатором activityId и идентификации существующего действия Process Action с помощью этого идентификатора для корреляции с ним. Для синхронных запросов ответ блокируется и поэтому известно, к какому действию Process Action относится ответ.

На следующем рисунке показаны действия клиента WCF, указанные в списке время создания (левая панель) и вложенные действия и трассировки (верхняя правая панель):

![Снимок экрана, показывающий действия клиента WCF, перечисленные по времени создания.](./media/using-service-trace-viewer-for-viewing-correlated-traces-and-troubleshooting/wcf-client-activities-creation-time.gif)

Когда на левой панели выбирается действие, на верхней правой панели отображаются вложенные действия и трассировки, т. е. это уменьшенное иерархическое представление списка действий слева на основе выбранного родительского действия. Поскольку первым сделанным запросом является выбранное действие Process action Add, это действие содержит действие Set Up Secure Session (перенаправление в, перенаправление назад от) и трассировки фактической обработки действия Add.

Если дважды щелкнуть действие обработка добавить действие на левой панели, можно увидеть графическое представление действий клиента WCF, связанных с добавлением. Первое действие слева - корневое действие (0000), являющееся действием по умолчанию. WCF передает внешние действия. Если это не определено, WCF передает данные из 0000. В данном случае второе действие, Process Action Add, выполняет перенаправление из действия 0. Затем следует действие Setup Secure Session.

На следующем рисунке показано представление графа действий клиента WCF, а именно активность окружающей среды (здесь 0), действие обработки и настройка безопасного сеанса.

![Диаграмма в средстве просмотра трассировки, показывающая внешние действия и действие обработки.](./media/using-service-trace-viewer-for-viewing-correlated-traces-and-troubleshooting/wcf-activities-graph-ambient-process.gif)

На верхней правой панели отображаются все трассировки, связанные с действием Process Action Add. В частности, передано сообщение запроса ("Передано сообщение по каналу") и в том же действии принят ответ ("Получено сообщение по каналу"). Это показано на следующей диаграмме. Для ясности действие Set up Secure Session на диаграмме свернуто.

На следующем рисунке показан список трассировок для действия "Обработка действия". Мы отправим запрос и получаем ответ в том же действии.

![Снимок экрана: средство просмотра трассировки с отображением списка трассировок для действия "Обработка действия"](./media/using-service-trace-viewer-for-viewing-correlated-traces-and-troubleshooting/process-action-traces.gif)

Здесь мы загружаем трассировку клиента только для ясности, но трассировки службы (сообщения запроса и сообщения ответа) отображаются в том же действии, если они также загружены в средство и для которых `propagateActivity` было задано значение `true.` это показано на более позднем рисунке.

В службе модель действий сопоставляется с концепциями WCF следующим образом:

1. Создается и открывается ServiceHost (при этом может создаваться несколько действий, связанных с основным приложением, например, в случае использования средств обеспечения безопасности).

2. Создается действие Listen At для каждого прослушивателя в ServiceHost (с перенаправлениями в действие Open ServiceHost и из этого действия).

3. Когда прослушиватель обнаруживает запрос на соединение, инициированный клиентом, он передается действию "Receive Bytes", в котором обрабатываются все байты, отправленные клиентом. В этом действии можно увидеть любые ошибки соединения, которые произошли во время взаимодействия между клиентом и службой.

4. Для каждого полученного набора байтов, который соответствует сообщению, мы обработаем эти байты в действии "обработка сообщения", где мы создаем объект сообщения WCF. В этом действии отображаются ошибки, связанные с неправильным конвертом или неверно сформированным сообщением.

5. Когда сообщение сформировано, выполняется перенаправление в действие Process Action. Если для `propagateActivity` задано значение `true` и на клиенте, и в службе, это действие имеет тот же идентификатор, что определен в клиенте и описан ранее. С этого этапа мы начнем использовать преимущества прямой корреляции между конечными точками, так как все трассировки, созданные в WCF, связанные с запросом, находятся в том же действии, включая обработку ответного сообщения.

6. Для необработанного действия мы создадим действие "выполнить код пользователя", чтобы изолировать трассировки, созданные в пользовательском коде, из тех, которые были созданы в WCF. В предыдущем примере трассировка "служба отправляет ответ на добавление ответа" создается в действии "выполнение кода пользователя", а не в действии, распространенном клиентом, если применимо.

На приведенной ниже иллюстрации первое действие слева - корневое действие (0000), являющееся действием по умолчанию. Следующие три действия предназначены для того, чтобы открыть ServiceHost. Действие в столбце 5 - прослушиватель, а остальные действия (6 – 8) описывают обработку сообщения системой WCF - от обработки байтов до активации пользовательского кода.

На следующем рисунке показано представление действий службы WCF в графе:

![Снимок экрана средства просмотра трассировки с отображением списка действий службы WCF](./media/using-service-trace-viewer-for-viewing-correlated-traces-and-troubleshooting/wcf-service-activities.gif)

На следующем снимке экрана показаны действия для клиента и службы и выделено действие Process Action Add во всех процессах (оранжевым цветом). Стрелки связывают сообщения запроса и ответа, отправленные и полученные клиентом и службой. Трассировки действия Process Action разделены в процессах на диаграмме, но в верхней правой панели показаны как часть одного действия. В этой панели отображаются трассировки клиента для отправленных сообщений, после которых следуют трассировки службы для полученных и обработанных сообщений.

На следующих изображениях показано представление графика как для клиента WCF, так и для действий службы.

![Граф из средства просмотра трассировки, отображающего как клиент WCF, так и действия службы.](./media/using-service-trace-viewer-for-viewing-correlated-traces-and-troubleshooting/wcf-client-service-activities.gif)

В следующем сценарии с ошибками соотносятся трассировки ошибок и предупреждений в службе и на клиенте. Сначала вызывается исключение в пользовательском коде службы (крайнее правое зеленое действие, которое включает трассировку предупреждений для исключения "Служба не может обработать этот запрос в пользовательском коде"). Когда клиенту отправляется ответ, снова создается трассировка предупреждений, чтобы указать на наличие сообщения о сбое (розовое действие слева). Затем клиент закрывает свой клиент WCF (желтое действие внизу слева), в результате чего соединение со службой прерывается. Служба вызывает ошибку (самое длинное розовое действие справа).

![Использование средства просмотра трассировки](media/wcfc-e2etrace9s.gif "wcfc_e2etrace9s")

Корреляция ошибок в службе и на клиенте

Образец, использованный для создания этих трассировок, представляет собой последовательность синхронных запросов, использующих привязку wsHttpBinding. Для сценариев без обеспечения безопасности или с асинхронными запросами, где действие Process Action выполняет операции начала и окончания, составляющие асинхронный вызов, и показывает перенаправления в действие обратного вызова, диаграмма будет несколько иной. Дополнительные сведения о дополнительных сценариях см. [в разделе Сценарии сквозной трассировки](end-to-end-tracing-scenarios.md).

## <a name="troubleshooting-using-the-service-trace-viewer"></a>Выявление неполадок с помощью программы Service Trace Viewer

При загрузке файлов трассировки в программу Service Trace Viewer можно выбрать любое красное или желтое действие на левой панели, чтобы выявить причину неполадки в приложении. Действие 000 обычно имеет необработанные исключения, которые достигают пользователя.

На следующем рисунке показано, как выбрать действие красного или желтого цвета для выявления корня проблемы.
![Снимок экрана с красным или желтыми действиями для поиска корня проблемы.](./media/using-service-trace-viewer-for-viewing-correlated-traces-and-troubleshooting/service-trace-viewer.gif)

На верхней правой панели можно проанализировать трассировки, связанные с действием, выбранным на левой панели. Затем можно просмотреть красные или желтые трассировки в этой панели и увидеть, как они коррелируются. На приведенной выше диаграмме видны трассировки предупреждений для клиента и службы в одном действии Process Action.

Если эти трассировки не позволяют выяснить первопричину ошибки, можно использовать диаграмму, дважды щелкнув выбранное действие на левой панели (здесь Process Action). При этом отображается диаграмма со связанными действиями. Затем можно развернуть связанные действия (щелкнув знак "+"), чтобы найти первую выданную трассировку красным или желтым цветом в связанном действии. Сохраняйте развернутыми действия, которые произошли непосредственно перед представляющей интерес красной или желтой трассировкой, следя за перенаправлениями в связанные действия или потоками сообщений через конечные точки, пока не выясните основную причину неполадки.

![Использование средства просмотра трассировки](media/wcfc-e2etrace9s.gif "wcfc_e2etrace9s")

Развертывание действий для выяснения основной причины неполадки

Если трассировка `ActivityTracing` ServiceModel отключена, а трассировка ServiceModel включена, можно увидеть трассировки ServiceModel, созданные в действии 0000. Однако в этом случае требуется больше усилий, чтобы понять корреляцию этих трассировок.

Если включено ведение журнала сообщений, можно использовать вкладку сообщений, чтобы увидеть, на какое сообщение повлияла ошибка. При двойном щелчке красного или желтого сообщения появляется графическое представление связанных действий. Эти действия наиболее тесно связаны с запросом, где произошла ошибка.

![Снимок экрана средства просмотра трассировки с включенным ведением журнала сообщений.](./media/using-service-trace-viewer-for-viewing-correlated-traces-and-troubleshooting/message-logging-enabled.gif)

Чтобы начать устранение неполадок, можно также выбрать трассировку сообщений красного или желтого цвета и дважды щелкнуть ее для отслеживания основной причины.

## <a name="see-also"></a>См. также

- [Сценарии сквозной трассировки](end-to-end-tracing-scenarios.md)
- [Программа Service Trace Viewer (SvcTraceViewer.exe)](../../service-trace-viewer-tool-svctraceviewer-exe.md)
- [Трассировка](index.md)
