---
description: Дополнительные сведения о создании длительно выполняемой службы рабочих процессов
title: Создание службы долго выполняющегося рабочего процесса
ms.date: 03/30/2017
ms.assetid: 4c39bd04-5b8a-4562-a343-2c63c2821345
ms.openlocfilehash: 9d26e763e2515f9e9ec2b61201512f02eeaeb1bc
ms.sourcegitcommit: ddf7edb67715a5b9a45e3dd44536dabc153c1de0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/06/2021
ms.locfileid: "99756907"
---
# <a name="create-a-long-running-workflow-service"></a>Создание длительно выполняющейся службы рабочего процесса

В данном разделе описывается, как создать службу длительных рабочих процессов. Службы длительных рабочих процессов могут работать в течение долгого времени. В определенные моменты рабочий процесс может переходить в состояние бездействия в ожидании дополнительных данных. В этом случае рабочий процесс сохраняется в базе данных SQL и удаляется из памяти. При поступлении дополнительных данных экземпляр рабочего процесса снова загружается в память и его выполнение продолжается.  В этом сценарии реализуется очень упрощенная система обработки заказов.  Клиент отправляет первоначальное сообщение службе рабочего процесса с указанием начать заказ. Служба возвращает клиенту идентификатор заказа. С этого момента в ожидании нового сообщения от клиента служба рабочего процесса переходит в состояние бездействия и сохраняется в базе данных SQL Server.  Когда клиент отправит следующее сообщение, чтобы заказать товар, служба рабочего процесса будет снова загружена в память, после чего она завершит обработку заказа. В приведенном образце кода служба возвращает строку, указывающую на то, что товар добавлен в заказ. Этот образец кода не предполагает реализацию такого приложения в реальности, скорее это простой образец, иллюстрирующий работу служб длительных рабочих процессов. В этом разделе предполагается, что вы умеете создавать проекты и решения Visual Studio 2012.

## <a name="prerequisites"></a>Предварительные требования

Чтобы воспользоваться этим пошаговым руководством, необходимо установить следующее программное обеспечение:

1. Microsoft SQL Server 2008

2. Visual Studio 2012

3. Microsoft [!INCLUDE[netfx_current_long](../../../../includes/netfx-current-long-md.md)]

4. Вы знакомы с WCF и Visual Studio 2012 и знаете, как создавать проекты и решения.

## <a name="set-up-the-sql-database"></a>Настройка базы данных SQL

1. Для сохранения экземпляров служб рабочих процессов требуется установленный Microsoft SQL Server, на котором необходимо настроить базу данных для хранения выгруженных из памяти экземпляров рабочих процессов. Запустите Microsoft SQL Management Studio, нажав кнопку **Пуск** , выбрав **все программы**, **Microsoft SQL Server 2008** и **Microsoft SQL Management Studio**.

2. Чтобы войти в SQL Server экземпляр, нажмите кнопку " **Подключиться** "

3. Щелкните правой кнопкой мыши **базы данных** в представлении в виде дерева и выберите пункт **создать базу данных.** для создания новой базы данных с именем `SQLPersistenceStore` .

4. Выполните в базе данных SQLPersistenceStore файл скрипта SqlWorkflowInstanceStoreSchema.sql, расположенный в каталоге C:\Windows\Microsoft.NET\Framework\v4.0\SQL\en, чтобы настроить требуемые схемы базы данных.

5. Выполните в базе данных SQLPersistenceStore файл скрипта SqlWorkflowInstanceStoreLogic.sql, расположенный в каталоге C:\Windows\Microsoft.NET\Framework\v4.0\SQL\en, чтобы настроить требуемую логику базы данных.

## <a name="create-the-web-hosted-workflow-service"></a>Создание службы веб-размещения рабочего процесса

1. Создайте пустое решение Visual Studio 2012, присвойте ему имя `OrderProcessing` .

2. Добавьте в него новый проект служебного приложения рабочего процесса WCF под названием `OrderService`.

3. В диалоговом окне Свойства проекта перейдите на вкладку **веб** .

    1. В разделе **действие при запуске** выберите **определенная страница** и укажите `Service1.xamlx` .

        ![Веб-свойства проекта службы рабочего процесса](./media/creating-a-long-running-workflow-service/start-action-specific-page-option.png "Создание веб-страницы, размещенной в службе рабочего процесса, для конкретной службы")

    2. В разделе **серверы** выберите **использовать локальный веб-сервер IIS**.

        ![Параметры локального веб-сервера](./media/creating-a-long-running-workflow-service/use-local-web-server.png "Создание службы веб-размещения рабочих процессов — использование локального веб-сервера IIS")

        > [!WARNING]
        > Чтобы использовать этот параметр, необходимо запустить Visual Studio 2012 в режиме администратора.

        Эти шаги необходимы, чтобы настроить размещение проекта службы рабочего процесса в IIS.

4. Откройте, `Service1.xamlx` если он еще не открыт, и удалите существующие действия **действия ReceiveRequest** и **SendResponse** .

5. Выберите действие **Последовательная служба** и щелкните ссылку **переменные** и добавьте переменные, показанные на следующем рисунке. Эти переменные будут в дальнейшем использоваться в службе рабочего процесса.

    > [!NOTE]
    > Если Коррелатионхандле не находится в раскрывающемся списке Тип переменной, выберите в раскрывающемся списке пункт **Обзор типов** . Введите Коррелатионхандле в поле **имя типа** , выберите коррелатионхандле в списке и нажмите кнопку **ОК**.

    ![Добавить переменные](./media/creating-a-long-running-workflow-service/add-variables-sequential-service-activity.gif "Добавьте переменные в действие последовательной службы.")

6. Перетащите шаблон действия **ReceiveAndSendReply** в действие **последовательной службы** . Этот набор действий будет получать сообщение от клиента и возвращать ему ответ.

    1. Выберите действие **получить** и задайте свойства, выделенные на следующем рисунке.

        ![Задание свойств действия Receive](./media/creating-a-long-running-workflow-service/set-receive-activity-properties.png "Задайте свойства действия получения.")

        Свойство DisplayName задает имя, отображаемое для действия «Receive» в конструкторе. Свойства ServiceContractName и OperationName задают имя контракта службы и операции, которые реализуются действием Receive. Дополнительные сведения об использовании контрактов в службах рабочих процессов см. в статье [использование контрактов в рабочем процессе](using-contracts-in-workflow.md).

    2. Щелкните ссылку **define...** в действии **рецеивестартордер** и задайте свойства, показанные на следующем рисунке.  Обратите внимание, что выбран переключатель **Параметры** , параметр с именем `p_customerName` привязан к `customerName` переменной. Это настраивает действие **Receive** для получения данных и привязывает эти данные к локальным переменным.

        ![Задание данных, получаемых действием Receive](./media/creating-a-long-running-workflow-service/set-properties-for-receive-content.png "Задайте свойства для данных, полученных действием Receive.")

    3. Выберите действие **SendReplyToReceive** и задайте выделенное свойство, показанное на следующем рисунке.

        ![Задание свойств действия SendReply](./media/creating-a-long-running-workflow-service/set-properties-for-reply-activities.png "сетреплипропертиес")

    4. Щелкните ссылку **define...** в действии **сендреплитостартордер** и задайте свойства, показанные на следующем рисунке. Обратите внимание, что выбран переключатель **Параметры** ; параметр с именем `p_orderId` привязан к `orderId` переменной. Этот параметр указывает, что действие SendReplyToStartOrder возвратит вызывающему объекту значение типа String.

        ![Настройка данных для содержимого действия SendReply](./media/creating-a-long-running-workflow-service/setreplycontent-for-sendreplytostartorder-activity.png "Настройка параметра для действия Сетреплитостартордер.")

    5. Перетащите действие Assign (назначение) между действиями **Receive** и **SendReply** и задайте свойства, как показано на следующем рисунке.

        ![Добавление действия Assign](./media/creating-a-long-running-workflow-service/add-an-assign-activity.png "Добавьте действие Assign.")

        При этом будет создан новый идентификатор заказа, а его значение будет помещено в переменную orderId.

    6. Выберите действие **реплитостартордер** . В окне Свойства нажмите кнопку с многоточием для **CorrelationInitializers**. Выберите ссылку **Добавить инициализатор** , введите `orderIdHandle` в текстовом поле инициализатор, выберите инициализатор корреляции запросов для типа корреляции и выберите p_orderId в раскрывающемся списке запросы XPath. Эти параметры показаны на следующем рисунке. Нажмите кнопку **OK**.  При этом будет инициализирована новая корреляция между клиентом и этим экземпляром службы рабочего процесса. При получении сообщения с этим идентификатором заказа оно будет направлено этому экземпляру службы рабочего процесса.

        ![Добавление инициализатора корреляции](./media/creating-a-long-running-workflow-service/add-correlationinitializers.png "Добавьте инициализатор корреляции.")

7. Перетащите еще одно действие **ReceiveAndSendReply** в конец рабочего процесса (за пределами **последовательности** , содержащей первые действия **Receive** и **SendReply** ). Оно получит второе сообщение от клиента и ответит на него.

    1. Выберите **последовательность** , содержащую только что добавленные действия **Receive** и **SendReply** , и нажмите кнопку **переменные** . Добавьте переменную, отмеченную на следующем рисунке.

        ![Добавление новых переменных](./media/creating-a-long-running-workflow-service/add-the-itemid-variable.png "Добавьте переменную ItemId.")

        Также добавьте `orderResult` в область в качестве **строки** `Sequence` .

    2. Выберите действие **получить** и задайте свойства, показанные на следующем рисунке:

        ![Задание свойств действия получения](./media/creating-a-long-running-workflow-service/set-receive-activities-properties.png "Задайте свойства действий получения.")

        > [!NOTE]
        > Не забудьте изменить поле **одинаковыми servicecontractname** на `../IAddItem` .

    3. Щелкните ссылку **define...** в действии **рецеивеаддитем** и добавьте параметры, показанные на следующем рисунке: настраивает действие Receive для принятия двух параметров, идентификатор заказа и идентификатор упорядоченного элемента.

        ![Указание параметров для второго получения](./media/creating-a-long-running-workflow-service/add-receive-two-parameters.png "Настройте действие Receive для получения двух параметров.")

    4. Нажмите кнопку с многоточием **коррелатеон** и введите `orderIdHandle` . В разделе **запросы XPath** щелкните стрелку раскрывающегося списка и выберите `p_orderId` . При этом будет настроена корреляция второго действия Receive. Дополнительные сведения о корреляции см. в разделе [корреляция](correlation.md).

        ![Задание свойства CorrelatesOn](./media/creating-a-long-running-workflow-service/correlateson-setting.png "Задайте свойство CorrelatesOn.")

    5. Перетаскивание действия **If** сразу после действия **рецеивеаддитем** . Это действие работает аналогично инструкции IF.

        1. Присвойте свойству **Condition** значение. `itemId=="Zune HD" (itemId="Zune HD" for Visual Basic)`

        2. Перетащите действие Assign ( **назначение** ) в раздел Then, а другой **—** в раздел **else** , чтобы установить свойства действий **назначения** , как показано на следующем рисунке.

            ![Задание результата вызова службы](./media/creating-a-long-running-workflow-service/assign-result-of-service-call.png "Назначьте результат вызова службы.")

            Если условием является `true` , будет выполнен раздел **then** . Значение, если условие выполняется `false` в разделе **else** .

        3. Выберите действие **SendReplyToReceive** и задайте свойство **DisplayName** , как показано на следующем рисунке.

            ![Задание свойств действия SendReply](./media/creating-a-long-running-workflow-service/send-reply-activity-property.png "Задайте свойство действия SendReply.")

        4. Щелкните ссылку **define...** в действии **сетреплитоаддитем** и настройте его, как показано на следующем рисунке. Это настраивает действие **сендреплитоаддитем** для возврата значения в `orderResult` переменной.

            ![Настройка привязки данных для действия SendReply](./media/creating-a-long-running-workflow-service/set-property-for-sendreplytoadditem.gif "Задание свойства для действия Сендреплитоаддитем.")

8. Откройте файл web.config и добавьте в раздел следующие элементы, \<behavior> чтобы включить сохранение рабочего процесса.

    ```xml
    <sqlWorkflowInstanceStore connectionString="Data Source=your-machine\SQLExpress;Initial Catalog=SQLPersistenceStore;Integrated Security=True;Asynchronous Processing=True" instanceEncodingOption="None" instanceCompletionAction="DeleteAll" instanceLockedExceptionAction="BasicRetry" hostLockRenewalPeriod="00:00:30" runnableInstancesDetectionPeriod="00:00:02" />
              <workflowIdle timeToUnload="0"/>
    ```

    > [!WARNING]
    > В приведенном выше фрагменте кода необходимо заменить имя узла и экземпляра SQL Server.

9. Создайте решение.

## <a name="create-a-client-application-to-call-the-workflow-service"></a>Создание клиентского приложения для вызова службы рабочего процесса

1. Добавьте в решение новый проект консольного приложения с именем `OrderClient`.

2. Добавьте в проект `OrderClient` ссылки на следующие сборки:

    1. System.ServiceModel.dll

    2. System.ServiceModel.Activities.dll

3. Добавьте ссылку на службу рабочего процесса и укажите `OrderService` в качестве пространства имен.

4. В метод `Main()` клиентского проекта добавьте следующий код:

    ```csharp
    static void Main(string[] args)
    {
       // Send initial message to start the workflow service
       Console.WriteLine("Sending start message");
       StartOrderClient startProxy = new StartOrderClient();
       string orderId = startProxy.StartOrder("Kim Abercrombie");

       // The workflow service is now waiting for the second message to be sent
       Console.WriteLine("Workflow service is idle...");
       Console.WriteLine("Press [ENTER] to send an add item message to reactivate the workflow service...");
       Console.ReadLine();

       // Send the second message
       Console.WriteLine("Sending add item message");
       AddItemClient addProxy = new AddItemClient();
       AddItem item = new AddItem();
       item.p_itemId = "Zune HD";
       item.p_orderId = orderId;

       string orderResult = addProxy.AddItem(item);
       Console.WriteLine("Service returned: " + orderResult);
    }
    ```

5. Выполните построение решения и запустите приложение `OrderClient`. Клиент выведет на экран следующий текст.

    ```output
    Sending start messageWorkflow service is idle...Press [ENTER] to send an add item message to reactivate the workflow service...
    ```

6. Чтобы убедиться, что служба рабочего процесса сохранена, запустите SQL Server Management Studio, перейдя в меню " **Пуск** ", выбрав " **все программы**", **Microsoft SQL Server 2008**, **SQL Server Management Studio**.

    1. В области слева разверните, **базы данных**, **склперсистенцесторе**, **представления** и щелкните правой кнопкой мыши элемент **System. activitys. DurableInstancing. instances** и выберите **пункт выбрать первые 1000 строк**. Убедитесь, что в области **результатов** отображается хотя бы один экземпляр. Если во время работы возникнет исключение, в этой области могут быть указаны и другие экземпляры, оставшиеся от прошлых запусков. Можно удалить существующие строки, щелкнув правой кнопкой мыши **System. activitys. DurableInstancing. Instances** и выбрав пункт **изменить первые 200 строк**, нажав кнопку **выполнить** , выбрав все строки на панели результатов и выбрав пункт **Удалить**.  Чтобы проверить, что в базе данных отображается экземпляр, созданный учебным приложением, перед запуском клиента удалите все записи из представления экземпляров. После запуска клиента выполните этот запрос («Выделить 1000 верхних строк») еще раз и удостоверьтесь, что новый экземпляр добавлен.

7. Нажмите клавишу ВВОД, чтобы отправить сообщение о добавлении товара службе рабочего процесса. Клиент выведет на экран следующий текст.

    ```output
    Sending add item messageService returned: Item added to orderPress any key to continue . . .
    ```

## <a name="see-also"></a>См. также

- [Службы рабочего процесса](workflow-services.md)
